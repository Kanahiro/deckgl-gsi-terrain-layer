{"version":3,"sources":["../../../src/lib/model.js"],"names":["isWebGL","ProgramManager","Program","VertexArray","clear","TransformFeedback","Buffer","log","isObjectEmpty","uid","assert","getDebugTableForUniforms","getDebugTableForVertexArray","getDebugTableForProgramConfiguration","getBuffersFromGeometry","LOG_DRAW_PRIORITY","LOG_DRAW_TIMEOUT","ERR_MODEL_PARAMS","NOOP","DRAW_PARAMS","Model","gl","props","id","lastLogTime","initialize","programManager","getDefaultProgramManager","_programManagerState","_managedProgram","program","vs","fs","modules","defines","inject","varyings","bufferMode","transpileToGLSL100","programProps","vertexArray","_programDirty","userData","needsRedraw","_attributes","attributes","uniforms","pickable","_checkProgram","setUniforms","Object","assign","getModuleUniforms","moduleSettings","drawMode","undefined","vertexCount","geometryBuffers","isInstanced","instanced","instanceCount","_setModelProps","geometry","Number","isFinite","key","release","_deleteGeometryBuffers","getVertexCount","setAttributes","normalizedAttributes","name","attribute","getValue","opts","getUniforms","framebuffer","transformFeedback","parameters","updateModuleSettings","logPriority","priority","_logDrawCallStart","drawParams","getDrawParams","isIndexed","indexType","indexOffset","vertexArrayInstanced","warn","onBeforeRender","onAfterRender","didDraw","draw","getDrawMode","offset","_logDrawCallEnd","discard","feedbackBuffers","unbindModels","_setFeedbackBuffers","forEach","model","unbindBuffers","bindBuffers","setGeometry","_feedbackBuffers","shaderCache","needsUpdate","stateHash","get","setProps","buffer","animationProps","animated","animatedUniforms","_evaluateAnimateUniforms","setBuffers","logLevel","logDrawTimeout","Date","now","group","collapsed","level","attributeTable","header","uniformTable","table","unusedTable","unusedCount","undefinedOnly","missingTable","missingCount","count","keys","configTable","configuration","message","groupEnd"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\n\nimport GL from '@luma.gl/constants';\nimport {isWebGL} from '@luma.gl/gltools';\nimport ProgramManager from './program-manager';\nimport {\n  Program,\n  VertexArray,\n  clear,\n  TransformFeedback,\n  Buffer,\n  log,\n  isObjectEmpty,\n  uid,\n  assert\n} from '@luma.gl/webgl';\nimport {\n  getDebugTableForUniforms,\n  getDebugTableForVertexArray,\n  getDebugTableForProgramConfiguration\n} from '@luma.gl/webgl';\nimport {getBuffersFromGeometry} from './model-utils';\n\nconst LOG_DRAW_PRIORITY = 2;\nconst LOG_DRAW_TIMEOUT = 10000;\n\nconst ERR_MODEL_PARAMS = 'Model needs drawMode and vertexCount';\n\nconst NOOP = () => {};\nconst DRAW_PARAMS = {};\n\nexport default class Model {\n  constructor(gl, props = {}) {\n    // Deduce a helpful id\n    const {id = uid('model')} = props;\n    assert(isWebGL(gl));\n    this.id = id;\n    this.gl = gl;\n    this.id = props.id || uid('Model');\n    this.lastLogTime = 0; // TODO - move to probe.gl\n    this.initialize(props);\n  }\n\n  initialize(props) {\n    this.props = {};\n\n    this.programManager = props.programManager || ProgramManager.getDefaultProgramManager(this.gl);\n    this._programManagerState = -1;\n    this._managedProgram = false;\n\n    const {\n      program = null,\n      vs,\n      fs,\n      modules,\n      defines,\n      inject,\n      varyings,\n      bufferMode,\n      transpileToGLSL100\n    } = props;\n\n    this.programProps = {\n      program,\n      vs,\n      fs,\n      modules,\n      defines,\n      inject,\n      varyings,\n      bufferMode,\n      transpileToGLSL100\n    };\n    this.program = null;\n    this.vertexArray = null;\n    this._programDirty = true;\n\n    // Initialize state\n    this.userData = {};\n    this.needsRedraw = true;\n\n    // Attributes and buffers\n    // Model manages auto Buffer creation from typed arrays\n    this._attributes = {}; // All attributes\n    this.attributes = {}; // User defined attributes\n\n    // Model manages uniform animation\n    this.uniforms = {};\n\n    // picking options\n    this.pickable = true;\n\n    this._checkProgram();\n\n    this.setUniforms(\n      Object.assign(\n        {},\n        this.getModuleUniforms(props.moduleSettings) // Get unforms for supplied parameters\n      )\n    );\n\n    this.drawMode = props.drawMode !== undefined ? props.drawMode : GL.TRIANGLES;\n    this.vertexCount = props.vertexCount || 0;\n\n    // Track buffers created by setGeometry\n    this.geometryBuffers = {};\n\n    // geometry might have set drawMode and vertexCount\n    this.isInstanced = props.isInstanced || props.instanced || props.instanceCount > 0;\n\n    this._setModelProps(props);\n\n    // TODO - just to unbreak deck.gl 7.0-beta, remove as soon as updated\n    this.geometry = {};\n\n    // assert(program || program instanceof Program);\n    assert(this.drawMode !== undefined && Number.isFinite(this.vertexCount), ERR_MODEL_PARAMS);\n  }\n\n  setProps(props) {\n    this._setModelProps(props);\n  }\n\n  delete() {\n    // delete all attributes created by this model\n    // TODO - should buffer deletes be handled by vertex array?\n    for (const key in this._attributes) {\n      if (this._attributes[key] !== this.attributes[key]) {\n        this._attributes[key].delete();\n      }\n    }\n\n    if (this._managedProgram) {\n      this.programManager.release(this.program);\n      this._managedProgram = false;\n    }\n\n    this.vertexArray.delete();\n\n    this._deleteGeometryBuffers();\n  }\n\n  // GETTERS\n\n  getDrawMode() {\n    return this.drawMode;\n  }\n\n  getVertexCount() {\n    return this.vertexCount;\n  }\n\n  getInstanceCount() {\n    return this.instanceCount;\n  }\n\n  getAttributes() {\n    return this.attributes;\n  }\n\n  getProgram() {\n    return this.program;\n  }\n\n  setProgram(props) {\n    const {\n      program,\n      vs,\n      fs,\n      modules,\n      defines,\n      inject,\n      varyings,\n      bufferMode,\n      transpileToGLSL100\n    } = props;\n    this.programProps = {\n      program,\n      vs,\n      fs,\n      modules,\n      defines,\n      inject,\n      varyings,\n      bufferMode,\n      transpileToGLSL100\n    };\n    this._programDirty = true;\n  }\n\n  getUniforms() {\n    return this.uniforms;\n  }\n\n  // SETTERS\n\n  setDrawMode(drawMode) {\n    this.drawMode = drawMode;\n    return this;\n  }\n\n  setVertexCount(vertexCount) {\n    assert(Number.isFinite(vertexCount));\n    this.vertexCount = vertexCount;\n    return this;\n  }\n\n  setInstanceCount(instanceCount) {\n    assert(Number.isFinite(instanceCount));\n    this.instanceCount = instanceCount;\n    return this;\n  }\n\n  setGeometry(geometry) {\n    this.drawMode = geometry.drawMode;\n    this.vertexCount = geometry.getVertexCount();\n\n    this._deleteGeometryBuffers();\n\n    this.geometryBuffers = getBuffersFromGeometry(this.gl, geometry);\n    this.vertexArray.setAttributes(this.geometryBuffers);\n    return this;\n  }\n\n  setAttributes(attributes = {}) {\n    // Avoid setting needsRedraw if no attributes\n    if (isObjectEmpty(attributes)) {\n      return this;\n    }\n\n    const normalizedAttributes = {};\n    for (const name in attributes) {\n      const attribute = attributes[name];\n      // The `getValue` call provides support for deck.gl `Attribute` class\n      // TODO - remove once deck refactoring completes\n      normalizedAttributes[name] = attribute.getValue ? attribute.getValue() : attribute;\n    }\n\n    this.vertexArray.setAttributes(normalizedAttributes);\n    return this;\n  }\n\n  // TODO - should actually set the uniforms\n  setUniforms(uniforms = {}) {\n    Object.assign(this.uniforms, uniforms);\n\n    return this;\n  }\n\n  getModuleUniforms(opts) {\n    this._checkProgram();\n\n    const getUniforms = this.programManager.getUniforms(this.program);\n\n    if (getUniforms) {\n      return getUniforms(opts);\n    }\n\n    return {};\n  }\n\n  updateModuleSettings(opts) {\n    const uniforms = this.getModuleUniforms(opts || {});\n    return this.setUniforms(uniforms);\n  }\n\n  // DRAW CALLS\n\n  clear(opts) {\n    clear(this.program.gl, opts);\n    return this;\n  }\n\n  draw(opts = {}) {\n    // Lazy update program and vertex array\n    this._checkProgram();\n\n    const {\n      moduleSettings = null,\n      framebuffer,\n      uniforms = {},\n      attributes = {},\n      transformFeedback = this.transformFeedback,\n      parameters = {},\n      vertexArray = this.vertexArray\n    } = opts;\n\n    // Update model with any just provided attributes, settings or uniforms\n    this.setAttributes(attributes);\n    this.updateModuleSettings(moduleSettings);\n    this.setUniforms(uniforms);\n\n    let logPriority;\n\n    if (log.priority >= LOG_DRAW_PRIORITY) {\n      logPriority = this._logDrawCallStart(LOG_DRAW_PRIORITY);\n    }\n\n    const drawParams = this.vertexArray.getDrawParams();\n    const {\n      isIndexed = drawParams.isIndexed,\n      indexType = drawParams.indexType,\n      indexOffset = drawParams.indexOffset,\n      vertexArrayInstanced = drawParams.isInstanced\n    } = this.props;\n\n    if (vertexArrayInstanced && !this.isInstanced) {\n      log.warn('Found instanced attributes on non-instanced model', this.id)();\n    }\n\n    const {isInstanced, instanceCount} = this;\n\n    const {onBeforeRender = NOOP, onAfterRender = NOOP} = this.props;\n\n    onBeforeRender();\n\n    this.program.setUniforms(this.uniforms);\n\n    const didDraw = this.program.draw(\n      Object.assign(DRAW_PARAMS, opts, {\n        logPriority,\n        uniforms: null, // Already set (may contain \"function values\" not understood by Program)\n        framebuffer,\n        parameters,\n        drawMode: this.getDrawMode(),\n        vertexCount: this.getVertexCount(),\n        vertexArray,\n        transformFeedback,\n        isIndexed,\n        indexType,\n        isInstanced,\n        instanceCount,\n        offset: isIndexed ? indexOffset : 0\n      })\n    );\n\n    onAfterRender();\n\n    if (log.priority >= LOG_DRAW_PRIORITY) {\n      this._logDrawCallEnd(logPriority, vertexArray, framebuffer);\n    }\n\n    return didDraw;\n  }\n\n  // Draw call for transform feedback\n  transform(opts = {}) {\n    const {discard = true, feedbackBuffers, unbindModels = []} = opts;\n\n    let {parameters} = opts;\n\n    if (feedbackBuffers) {\n      this._setFeedbackBuffers(feedbackBuffers);\n    }\n\n    if (discard) {\n      parameters = Object.assign({}, parameters, {[GL.RASTERIZER_DISCARD]: discard});\n    }\n\n    unbindModels.forEach(model => model.vertexArray.unbindBuffers());\n    try {\n      this.draw(Object.assign({}, opts, {parameters}));\n    } finally {\n      unbindModels.forEach(model => model.vertexArray.bindBuffers());\n    }\n\n    return this;\n  }\n\n  // DEPRECATED METHODS\n\n  render(uniforms = {}) {\n    log.warn('Model.render() is deprecated. Use Model.setUniforms() and Model.draw()')();\n    return this.setUniforms(uniforms).draw();\n  }\n\n  // PRIVATE METHODS\n\n  _setModelProps(props) {\n    Object.assign(this.props, props);\n\n    if ('uniforms' in props) {\n      this.setUniforms(props.uniforms);\n    }\n\n    if ('pickable' in props) {\n      this.pickable = props.pickable;\n    }\n\n    if ('instanceCount' in props) {\n      this.instanceCount = props.instanceCount;\n    }\n    if ('geometry' in props) {\n      this.setGeometry(props.geometry);\n    }\n\n    // webgl settings\n    if ('attributes' in props) {\n      this.setAttributes(props.attributes);\n    }\n    if ('_feedbackBuffers' in props) {\n      this._setFeedbackBuffers(props._feedbackBuffers);\n    }\n  }\n\n  _checkProgram(shaderCache = null) {\n    const needsUpdate =\n      this._programDirty || this.programManager.stateHash !== this._programManagerState;\n\n    if (!needsUpdate) {\n      return;\n    }\n\n    let {program} = this.programProps;\n\n    if (program) {\n      this._managedProgram = false;\n    } else {\n      const {\n        vs,\n        fs,\n        modules,\n        inject,\n        defines,\n        varyings,\n        bufferMode,\n        transpileToGLSL100\n      } = this.programProps;\n      program = this.programManager.get({\n        vs,\n        fs,\n        modules,\n        inject,\n        defines,\n        varyings,\n        bufferMode,\n        transpileToGLSL100\n      });\n      if (this.program && this._managedProgram) {\n        this.programManager.release(this.program);\n      }\n      this._programManagerState = this.programManager.stateHash;\n      this._managedProgram = true;\n    }\n\n    assert(program instanceof Program, 'Model needs a program');\n\n    this._programDirty = false;\n\n    if (program === this.program) {\n      return;\n    }\n\n    this.program = program;\n\n    if (this.vertexArray) {\n      this.vertexArray.setProps({program: this.program, attributes: this.vertexArray.attributes});\n    } else {\n      this.vertexArray = new VertexArray(this.gl, {program: this.program});\n    }\n\n    // Make sure we have some reasonable default uniforms in place\n    this.setUniforms(\n      Object.assign(\n        {},\n        this.getModuleUniforms() // Get all default uniforms,\n      )\n    );\n  }\n\n  _deleteGeometryBuffers() {\n    for (const name in this.geometryBuffers) {\n      // Buffer is raw value (for indices) or first element of [buffer, accessor] pair\n      const buffer = this.geometryBuffers[name][0] || this.geometryBuffers[name];\n      if (buffer instanceof Buffer) {\n        buffer.delete();\n      }\n    }\n  }\n\n  // Updates (evaluates) all function valued uniforms based on a new set of animationProps\n  // experimental\n  _setAnimationProps(animationProps) {\n    if (this.animated) {\n      assert(animationProps, 'Model.draw(): animated uniforms but no animationProps');\n      const animatedUniforms = this._evaluateAnimateUniforms(animationProps);\n      Object.assign(this.uniforms, animatedUniforms);\n    }\n  }\n\n  // Transform Feedback\n\n  _setFeedbackBuffers(feedbackBuffers = {}) {\n    // Avoid setting needsRedraw if no feedbackBuffers\n    if (isObjectEmpty(feedbackBuffers)) {\n      return this;\n    }\n\n    const {gl} = this.program;\n    this.transformFeedback =\n      this.transformFeedback ||\n      new TransformFeedback(gl, {\n        program: this.program\n      });\n\n    this.transformFeedback.setBuffers(feedbackBuffers);\n    return this;\n  }\n\n  _logDrawCallStart(logLevel) {\n    const logDrawTimeout = logLevel > 3 ? 0 : LOG_DRAW_TIMEOUT;\n    if (Date.now() - this.lastLogTime < logDrawTimeout) {\n      return undefined;\n    }\n\n    this.lastLogTime = Date.now();\n\n    log.group(LOG_DRAW_PRIORITY, `>>> DRAWING MODEL ${this.id}`, {collapsed: log.level <= 2})();\n\n    return logLevel;\n  }\n\n  _logDrawCallEnd(logLevel, vertexArray, uniforms, framebuffer) {\n    // HACK: logLevel === undefined means logDrawCallStart didn't run\n    if (logLevel === undefined) {\n      return;\n    }\n\n    const attributeTable = getDebugTableForVertexArray({\n      vertexArray,\n      header: `${this.id} attributes`,\n      attributes: this._attributes\n    });\n\n    const {table: uniformTable, unusedTable, unusedCount} = getDebugTableForUniforms({\n      header: `${this.id} uniforms`,\n      program: this.program,\n      uniforms: Object.assign({}, this.program.uniforms, uniforms)\n    });\n\n    // log missing uniforms\n    const {table: missingTable, count: missingCount} = getDebugTableForUniforms({\n      header: `${this.id} uniforms`,\n      program: this.program,\n      uniforms: Object.assign({}, this.program.uniforms, uniforms),\n      undefinedOnly: true\n    });\n\n    if (missingCount > 0) {\n      log.log('MISSING UNIFORMS', Object.keys(missingTable))();\n      // log.table(logLevel, missingTable)();\n    }\n    if (unusedCount > 0) {\n      log.log('UNUSED UNIFORMS', Object.keys(unusedTable))();\n      // log.log(logLevel, 'Unused uniforms ', unusedTable)();\n    }\n\n    const configTable = getDebugTableForProgramConfiguration(this.vertexArray.configuration);\n\n    log.table(logLevel, attributeTable)();\n\n    log.table(logLevel, uniformTable)();\n\n    log.table(logLevel + 1, configTable)();\n\n    if (framebuffer) {\n      framebuffer.log({logLevel: LOG_DRAW_PRIORITY, message: `Rendered to ${framebuffer.id}`});\n    }\n\n    log.groupEnd(LOG_DRAW_PRIORITY, `>>> DRAWING MODEL ${this.id}`)();\n  }\n}\n"],"file":"model.js"}