{"version":3,"sources":["../../../../src/gpgpu/point-in-polygon/gpu-point-in-polygon.js"],"names":["Buffer","Texture2D","assert","isWebGL2","Transform","default","textureFilterModule","POLY_TEX_VS","FILTER_VS","Polygon","TEXTURE_SIZE","GPUPointInPolygon","gl","opts","textureSize","_setupResources","update","polygons","length","triangulatePolygons","vertices","indices","vertexCount","ids","_updateResources","positionBuffer","filterValueIndexBuffer","count","filterTransform","sourceBuffers","a_position","feedbackBuffers","filterValueIndex","elementCount","polygonTexture","boundingBox","run","moduleSettings","texture","format","type","dataFormat","border","mipmaps","parameters","accessor","size","idBuffer","indexBuffer","target","polyTextureTransform","id","_targetTexture","_targetTextureVarying","vs","drawMode","isIndexed","a_polygonID","modules","varyings","getBoundingBox","xMin","yMin","xMax","yMax","width","height","whRatio","texWidth","texHeight","resize","setData","Float32Array","Uint16Array","uniforms","boundingBoxOriginSize","positions","Infinity","y","x","i","SIZE","polygonId","normalized","normalize","curVertices","curCount","curIds","Array","fill","push","curIndices","getSurfaceIndices","indexCount","j","getVertexCount"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport {Buffer, Texture2D, assert} from '@luma.gl/webgl';\nimport {isWebGL2} from '@luma.gl/gltools';\nimport {Transform} from '@luma.gl/engine';\nimport {default as textureFilterModule} from './texture-filter';\nimport {POLY_TEX_VS, FILTER_VS} from './shaders';\nimport * as Polygon from './polygon';\nconst TEXTURE_SIZE = 512;\n\nexport default class GPUPointInPolygon {\n  constructor(gl, opts = {}) {\n    this.gl = gl;\n    assert(isWebGL2(gl)); // supports WebGL2 only\n    this.textureSize = TEXTURE_SIZE;\n    this._setupResources();\n    this.update(opts);\n  }\n\n  update({polygons, textureSize} = {}) {\n    if (textureSize) {\n      this.textureSize = textureSize;\n    }\n    if (!polygons || polygons.length === 0) {\n      return;\n    }\n\n    const {vertices, indices, vertexCount, ids} = triangulatePolygons(polygons);\n    this._updateResources(vertices, indices, ids, vertexCount);\n  }\n\n  filter({positionBuffer, filterValueIndexBuffer, count}) {\n    this.filterTransform.update({\n      sourceBuffers: {\n        a_position: positionBuffer\n      },\n      feedbackBuffers: {\n        filterValueIndex: filterValueIndexBuffer\n      },\n      elementCount: count\n    });\n    const {polygonTexture, boundingBox} = this;\n\n    this.filterTransform.run({\n      moduleSettings: {boundingBox, texture: polygonTexture}\n    });\n  }\n\n  // PRIVATE\n\n  _setupResources() {\n    const {gl} = this;\n\n    // texture to render polygons to\n    this.polygonTexture = new Texture2D(gl, {\n      format: GL.RGB,\n      type: GL.UNSIGNED_BYTE,\n      dataFormat: GL.RGB,\n      border: 0,\n      mipmaps: false,\n      parameters: {\n        [GL.TEXTURE_MAG_FILTER]: GL.NEAREST,\n        [GL.TEXTURE_MIN_FILTER]: GL.NEAREST,\n        [GL.TEXTURE_WRAP_S]: gl.CLAMP_TO_EDGE,\n        [GL.TEXTURE_WRAP_T]: gl.CLAMP_TO_EDGE\n      }\n    });\n    this.positionBuffer = new Buffer(gl, {accessor: {type: GL.FLOAT, size: 2}});\n    this.idBuffer = new Buffer(gl, {accessor: {type: GL.FLOAT, size: 1}});\n    this.indexBuffer = new Buffer(gl, {\n      target: GL.ELEMENT_ARRAY_BUFFER,\n      accessor: {type: GL.UNSIGNED_SHORT}\n    });\n\n    // transform to generate polygon texture\n    this.polyTextureTransform = new Transform(gl, {\n      id: `polygon-texture-creation-transform`,\n      elementCount: 0,\n      _targetTexture: this.polygonTexture,\n      _targetTextureVarying: 'v_polygonColor',\n      vs: POLY_TEX_VS,\n      drawMode: GL.TRIANGLES,\n      isIndexed: true,\n      sourceBuffers: {\n        a_position: this.positionBuffer,\n        a_polygonID: this.idBuffer,\n        indices: this.indexBuffer\n      }\n    });\n\n    // transform to perform filtering\n    this.filterTransform = new Transform(gl, {\n      id: 'filter transform',\n      vs: FILTER_VS,\n      modules: [textureFilterModule],\n      varyings: ['filterValueIndex']\n    });\n  }\n\n  _updateResources(vertices, indices, ids, vertexCount) {\n    const boundingBox = getBoundingBox(vertices, vertexCount);\n    const [xMin, yMin, xMax, yMax] = boundingBox;\n    const width = xMax - xMin;\n    const height = yMax - yMin;\n    const whRatio = width / height;\n    const {textureSize} = this;\n\n    // calculate max texture size with same aspect ratio\n    let texWidth = textureSize;\n    let texHeight = textureSize;\n    if (whRatio > 1) {\n      texHeight = texWidth / whRatio;\n    } else {\n      texWidth = texHeight * whRatio;\n    }\n\n    this.boundingBox = boundingBox;\n    this.polygonTexture.resize({width: texWidth, height: texHeight, mipmaps: false});\n    this.positionBuffer.setData(new Float32Array(vertices));\n    this.idBuffer.setData(new Float32Array(ids));\n    this.indexBuffer.setData(new Uint16Array(indices));\n    this.polyTextureTransform.update({\n      elementCount: indices.length,\n      _targetTexture: this.polygonTexture\n    });\n\n    this.polyTextureTransform.run({\n      uniforms: {\n        boundingBoxOriginSize: [xMin, yMin, width, height]\n      }\n    });\n  }\n}\n\n// Helper methods\n\nfunction getBoundingBox(positions, vertexCount) {\n  let yMin = Infinity;\n  let yMax = -Infinity;\n  let xMin = Infinity;\n  let xMax = -Infinity;\n  let y;\n  let x;\n\n  for (let i = 0; i < vertexCount; i++) {\n    x = positions[i * 2];\n    y = positions[i * 2 + 1];\n    yMin = y < yMin ? y : yMin;\n    yMax = y > yMax ? y : yMax;\n    xMin = x < xMin ? x : xMin;\n    xMax = x > xMax ? x : xMax;\n  }\n\n  return [xMin, yMin, xMax, yMax];\n}\n\nfunction triangulatePolygons(polygons) {\n  const SIZE = 2;\n  const vertices = [];\n  const indices = [];\n  const ids = [];\n  let count = 0;\n  let polygonId = 0;\n  for (let i = 0; i < polygons.length; i++) {\n    const normalized = Polygon.normalize(polygons[i], SIZE);\n    const curVertices = normalized.positions || normalized;\n    const curCount = curVertices.length / SIZE;\n    const curIds = new Array(curCount).fill(polygonId);\n    vertices.push(...curVertices);\n    ids.push(...curIds);\n    const curIndices = Polygon.getSurfaceIndices(normalized, SIZE);\n    const indexCount = curIndices.length;\n    for (let j = 0; j < indexCount; j++) {\n      curIndices[j] += count;\n    }\n    count += curCount;\n    indices.push(...curIndices);\n    polygonId++;\n  }\n\n  // UInt16 (UNSIGNED_SHORT) buffer is used for indices\n  assert(count < 65536); // 0xFFFF\n\n  const vertexCount = Polygon.getVertexCount(vertices, SIZE);\n\n  return {vertices, indices, ids, vertexCount};\n}\n"],"file":"gpu-point-in-polygon.js"}