{"version":3,"sources":["../../../src/gltf/gltf-material-parser.js"],"names":["Texture2D","hasFeature","FEATURES","log","GLTFMaterialParser","gl","attributes","material","pbrDebug","imageBasedLightingEnvironment","lights","useTangents","defines","MANUAL_SRGB","SRGB_FAST_APPROXIMATION","GLSL_TEXTURE_LOD","USE_TEX_LOD","uniforms","u_Camera","u_MetallicRoughnessValues","parameters","generatedTextures","u_DiffuseEnvSampler","getDiffuseEnvSampler","u_SpecularEnvSampler","getSpecularEnvSampler","u_brdfLUT","getBrdfTexture","u_ScaleIBLAmbient","u_ScaleDiffBaseMR","u_ScaleFGDSpec","defineIfPresent","NORMAL","TANGENT","TEXCOORD_0","parseMaterial","value","name","gltfTexture","define","texture","sampler","id","pixelStore","UNPACK_FLIP_Y_WEBGL","data","source","image","push","pbrMetallicRoughness","baseColorTexture","parseTexture","u_BaseColorFactor","baseColorFactor","metallicRoughnessTexture","metallicFactor","roughnessFactor","pbr_uUnlit","Boolean","unlit","parsePbrMetallicRoughness","normalTexture","scale","u_NormalScale","occlusionTexture","strength","u_OcclusionStrength","emissiveTexture","u_EmissiveFactor","emissiveFactor","alphaMode","alphaCutoff","ALPHA_CUTOFF","u_AlphaCutoff","warn","Object","assign","blend","blendEquation","FUNC_ADD","blendFunc","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","ONE"],"mappings":"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","sourcesContent":["import {Texture2D, hasFeature, FEATURES, log} from '@luma.gl/webgl';\n\nexport default class GLTFMaterialParser {\n  constructor(\n    gl,\n    {attributes, material, pbrDebug, imageBasedLightingEnvironment, lights, useTangents}\n  ) {\n    this.gl = gl;\n\n    this.defines = {\n      // TODO: Use EXT_sRGB if available (Standard in WebGL 2.0)\n      MANUAL_SRGB: 1,\n      SRGB_FAST_APPROXIMATION: 1\n    };\n\n    if (hasFeature(gl, FEATURES.GLSL_TEXTURE_LOD)) {\n      this.defines.USE_TEX_LOD = 1;\n    }\n\n    this.uniforms = {\n      // TODO: find better values?\n      u_Camera: [0, 0, 0], // Model should override\n\n      u_MetallicRoughnessValues: [1, 1] // Default is 1 and 1\n    };\n\n    this.parameters = {};\n    this.generatedTextures = [];\n\n    if (imageBasedLightingEnvironment) {\n      this.uniforms.u_DiffuseEnvSampler = imageBasedLightingEnvironment.getDiffuseEnvSampler();\n      this.uniforms.u_SpecularEnvSampler = imageBasedLightingEnvironment.getSpecularEnvSampler();\n      this.uniforms.u_brdfLUT = imageBasedLightingEnvironment.getBrdfTexture();\n      this.uniforms.u_ScaleIBLAmbient = [1, 1];\n    }\n\n    if (pbrDebug) {\n      // Override final color for reference app visualization\n      // of various parameters in the lighting equation.\n      this.uniforms.u_ScaleDiffBaseMR = [0, 0, 0, 0];\n      this.uniforms.u_ScaleFGDSpec = [0, 0, 0, 0];\n    }\n\n    this.defineIfPresent(attributes.NORMAL, 'HAS_NORMALS');\n    this.defineIfPresent(attributes.TANGENT && useTangents, 'HAS_TANGENTS');\n    this.defineIfPresent(attributes.TEXCOORD_0, 'HAS_UV');\n\n    this.defineIfPresent(imageBasedLightingEnvironment, 'USE_IBL');\n    this.defineIfPresent(lights, 'USE_LIGHTS');\n    this.defineIfPresent(pbrDebug, 'PBR_DEBUG');\n\n    if (material) {\n      this.parseMaterial(material);\n    }\n  }\n\n  defineIfPresent(value, name) {\n    if (value) {\n      this.defines[name] = 1;\n    }\n  }\n\n  parseTexture(gltfTexture, name, define = null) {\n    const parameters =\n      (gltfTexture.texture &&\n        gltfTexture.texture.sampler &&\n        gltfTexture.texture.sampler.parameters) ||\n      {};\n\n    const texture = new Texture2D(this.gl, {\n      id: gltfTexture.name || gltfTexture.id,\n      parameters,\n      pixelStore: {\n        [this.gl.UNPACK_FLIP_Y_WEBGL]: false\n      },\n      // Texture2D accepts a promise that returns an image as data (Async Textures)\n      data: gltfTexture.texture.source.image\n    });\n    this.uniforms[name] = texture;\n    this.defineIfPresent(define, define);\n    this.generatedTextures.push(texture);\n  }\n\n  parsePbrMetallicRoughness(pbrMetallicRoughness) {\n    if (pbrMetallicRoughness.baseColorTexture) {\n      this.parseTexture(\n        pbrMetallicRoughness.baseColorTexture,\n        'u_BaseColorSampler',\n        'HAS_BASECOLORMAP'\n      );\n    }\n    this.uniforms.u_BaseColorFactor = pbrMetallicRoughness.baseColorFactor || [1, 1, 1, 1];\n\n    if (pbrMetallicRoughness.metallicRoughnessTexture) {\n      this.parseTexture(\n        pbrMetallicRoughness.metallicRoughnessTexture,\n        'u_MetallicRoughnessSampler',\n        'HAS_METALROUGHNESSMAP'\n      );\n    }\n    const {metallicFactor = 1, roughnessFactor = 1} = pbrMetallicRoughness;\n    this.uniforms.u_MetallicRoughnessValues = [metallicFactor, roughnessFactor];\n  }\n\n  parseMaterial(material) {\n    this.uniforms.pbr_uUnlit = Boolean(material.unlit);\n\n    if (material.pbrMetallicRoughness) {\n      this.parsePbrMetallicRoughness(material.pbrMetallicRoughness);\n    }\n    if (material.normalTexture) {\n      this.parseTexture(material.normalTexture, 'u_NormalSampler', 'HAS_NORMALMAP');\n\n      const {scale = 1} = material.normalTexture;\n      this.uniforms.u_NormalScale = scale;\n    }\n    if (material.occlusionTexture) {\n      this.parseTexture(material.occlusionTexture, 'u_OcclusionSampler', 'HAS_OCCLUSIONMAP');\n\n      const {strength = 1} = material.occlusionTexture;\n      this.uniforms.u_OcclusionStrength = strength;\n    }\n    if (material.emissiveTexture) {\n      this.parseTexture(material.emissiveTexture, 'u_EmissiveSampler', 'HAS_EMISSIVEMAP');\n      this.uniforms.u_EmissiveFactor = material.emissiveFactor || [0, 0, 0];\n    }\n    if (material.alphaMode === 'MASK') {\n      const {alphaCutoff = 0.5} = material;\n      this.defines.ALPHA_CUTOFF = 1;\n      this.uniforms.u_AlphaCutoff = alphaCutoff;\n    } else if (material.alphaMode === 'BLEND') {\n      log.warn('BLEND alphaMode might not work well because it requires mesh sorting')();\n      Object.assign(this.parameters, {\n        blend: true,\n        blendEquation: this.gl.FUNC_ADD,\n        blendFunc: [\n          this.gl.SRC_ALPHA,\n          this.gl.ONE_MINUS_SRC_ALPHA,\n          this.gl.ONE,\n          this.gl.ONE_MINUS_SRC_ALPHA\n        ]\n      });\n    }\n  }\n}\n"],"file":"gltf-material-parser.js"}