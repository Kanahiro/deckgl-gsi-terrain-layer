{"version":3,"sources":["../../../src/gltf/create-gltf-model.js"],"names":["isWebGL2","log","pbr","ModelNode","GLTFMaterialParser","vs","fs","addVersionToShader","gl","source","createGLTFModel","options","id","drawMode","vertexCount","attributes","modelOptions","materialParser","info","defines","managedResources","push","generatedTextures","Object","values","map","attribute","buffer","model","assign","modules","parameters","setProps","setUniforms","uniforms"],"mappings":";AAAA,SAAQA,QAAR,QAAuB,kBAAvB;AACA,SAAQC,GAAR,QAAkB,gBAAlB;AACA,SAAQC,GAAR,QAAkB,sBAAlB;AACA,SAAQC,SAAR,QAAwB,eAAxB;AACA,OAAOC,kBAAP,MAA+B,wBAA/B;AAEA,IAAMC,EAAE,iuBAAR;AA2CA,IAAMC,EAAE,2LAAR;;AAYA,SAASC,kBAAT,CAA4BC,EAA5B,EAAgCC,MAAhC,EAAwC;AACtC,MAAIT,QAAQ,CAACQ,EAAD,CAAZ,EAAkB;AAChB,sCAA2BC,MAA3B;AACD;;AAED,SAAOA,MAAP;AACD;;AAED,eAAe,SAASC,eAAT,CAAyBF,EAAzB,EAA6BG,OAA7B,EAAsC;AAAA,MAC5CC,EAD4C,GACWD,OADX,CAC5CC,EAD4C;AAAA,MACxCC,QADwC,GACWF,OADX,CACxCE,QADwC;AAAA,MAC9BC,WAD8B,GACWH,OADX,CAC9BG,WAD8B;AAAA,MACjBC,UADiB,GACWJ,OADX,CACjBI,UADiB;AAAA,MACLC,YADK,GACWL,OADX,CACLK,YADK;AAEnD,MAAMC,cAAc,GAAG,IAAIb,kBAAJ,CAAuBI,EAAvB,EAA2BG,OAA3B,CAAvB;AAEAV,EAAAA,GAAG,CAACiB,IAAJ,CAAS,CAAT,EAAY,2BAAZ,EAAyCD,cAAc,CAACE,OAAxD;AAKA,MAAMC,gBAAgB,GAAG,EAAzB;AACAA,EAAAA,gBAAgB,CAACC,IAAjB,OAAAD,gBAAgB,qBAASH,cAAc,CAACK,iBAAxB,EAAhB;AACAF,EAAAA,gBAAgB,CAACC,IAAjB,OAAAD,gBAAgB,qBAASG,MAAM,CAACC,MAAP,CAAcT,UAAd,EAA0BU,GAA1B,CAA8B,UAAAC,SAAS;AAAA,WAAIA,SAAS,CAACC,MAAd;AAAA,GAAvC,CAAT,EAAhB;AAEA,MAAMC,KAAK,GAAG,IAAIzB,SAAJ,CACZK,EADY,EAEZe,MAAM,CAACM,MAAP,CACE;AACEjB,IAAAA,EAAE,EAAFA,EADF;AAEEC,IAAAA,QAAQ,EAARA,QAFF;AAGEC,IAAAA,WAAW,EAAXA,WAHF;AAIEgB,IAAAA,OAAO,EAAE,CAAC5B,GAAD,CAJX;AAKEiB,IAAAA,OAAO,EAAEF,cAAc,CAACE,OAL1B;AAMEY,IAAAA,UAAU,EAAEd,cAAc,CAACc,UAN7B;AAOE1B,IAAAA,EAAE,EAAEE,kBAAkB,CAACC,EAAD,EAAKH,EAAL,CAPxB;AAQEC,IAAAA,EAAE,EAAEC,kBAAkB,CAACC,EAAD,EAAKF,EAAL,CARxB;AASEc,IAAAA,gBAAgB,EAAhBA;AATF,GADF,EAYEJ,YAZF,CAFY,CAAd;AAkBAY,EAAAA,KAAK,CAACI,QAAN,CAAe;AAACjB,IAAAA,UAAU,EAAVA;AAAD,GAAf;AACAa,EAAAA,KAAK,CAACK,WAAN,CAAkBhB,cAAc,CAACiB,QAAjC;AAEA,SAAON,KAAP;AACD","sourcesContent":["import {isWebGL2} from '@luma.gl/gltools';\nimport {log} from '@luma.gl/webgl';\nimport {pbr} from '@luma.gl/shadertools';\nimport {ModelNode} from '../scenegraph';\nimport GLTFMaterialParser from './gltf-material-parser';\n\nconst vs = `\n#if (__VERSION__ < 300)\n  #define _attr attribute\n#else\n  #define _attr in\n#endif\n\n  _attr vec4 POSITION;\n\n  #ifdef HAS_NORMALS\n    _attr vec4 NORMAL;\n  #endif\n\n  #ifdef HAS_TANGENTS\n    _attr vec4 TANGENT;\n  #endif\n\n  #ifdef HAS_UV\n    _attr vec2 TEXCOORD_0;\n  #endif\n\n  void main(void) {\n    vec4 _NORMAL = vec4(0.);\n    vec4 _TANGENT = vec4(0.);\n    vec2 _TEXCOORD_0 = vec2(0.);\n\n    #ifdef HAS_NORMALS\n      _NORMAL = NORMAL;\n    #endif\n\n    #ifdef HAS_TANGENTS\n      _TANGENT = TANGENT;\n    #endif\n\n    #ifdef HAS_UV\n      _TEXCOORD_0 = TEXCOORD_0;\n    #endif\n\n    pbr_setPositionNormalTangentUV(POSITION, _NORMAL, _TANGENT, _TEXCOORD_0);\n    gl_Position = u_MVPMatrix * POSITION;\n  }\n`;\n\nconst fs = `\n#if (__VERSION__ < 300)\n  #define fragmentColor gl_FragColor\n#else\n  out vec4 fragmentColor;\n#endif\n\n  void main(void) {\n    fragmentColor = pbr_filterColor(vec4(0));\n  }\n`;\n\nfunction addVersionToShader(gl, source) {\n  if (isWebGL2(gl)) {\n    return `#version 300 es\\n${source}`;\n  }\n\n  return source;\n}\n\nexport default function createGLTFModel(gl, options) {\n  const {id, drawMode, vertexCount, attributes, modelOptions} = options;\n  const materialParser = new GLTFMaterialParser(gl, options);\n\n  log.info(4, 'createGLTFModel defines: ', materialParser.defines)();\n\n  // Calculate managedResources\n  // TODO: Implement resource management logic that will\n  // not deallocate resources/textures/buffers that are shared\n  const managedResources = [];\n  managedResources.push(...materialParser.generatedTextures);\n  managedResources.push(...Object.values(attributes).map(attribute => attribute.buffer));\n\n  const model = new ModelNode(\n    gl,\n    Object.assign(\n      {\n        id,\n        drawMode,\n        vertexCount,\n        modules: [pbr],\n        defines: materialParser.defines,\n        parameters: materialParser.parameters,\n        vs: addVersionToShader(gl, vs),\n        fs: addVersionToShader(gl, fs),\n        managedResources\n      },\n      modelOptions\n    )\n  );\n\n  model.setProps({attributes});\n  model.setUniforms(materialParser.uniforms);\n\n  return model;\n}\n"],"file":"create-gltf-model.js"}