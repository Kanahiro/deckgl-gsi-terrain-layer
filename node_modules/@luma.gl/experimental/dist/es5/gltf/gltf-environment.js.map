{"version":3,"sources":["../../../src/gltf/gltf-environment.js"],"names":["GLTFEnvironment","gl","brdfLutUrl","getTexUrl","specularMipLevels","id","getTextureForFace","parameters","pixels","TextureCube","FACES","forEach","face","mipmaps","_DiffuseEnvSampler","makeCube","dir","_SpecularEnvSampler","imageArray","lod","push","_BrdfTexture","Texture2D","data"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport {Texture2D, TextureCube} from '@luma.gl/webgl';\nimport {loadImage} from '@loaders.gl/images';\n\nexport default class GLTFEnvironment {\n  constructor(gl, {brdfLutUrl, getTexUrl, specularMipLevels = 10}) {\n    this.gl = gl;\n    this.brdfLutUrl = brdfLutUrl;\n    this.getTexUrl = getTexUrl;\n    this.specularMipLevels = specularMipLevels;\n  }\n\n  makeCube({id, getTextureForFace, parameters}) {\n    const pixels = {};\n    TextureCube.FACES.forEach(face => {\n      pixels[face] = getTextureForFace(face);\n    });\n    return new TextureCube(this.gl, {\n      id,\n      mipmaps: false,\n      parameters,\n      pixels\n    });\n  }\n\n  getDiffuseEnvSampler() {\n    if (!this._DiffuseEnvSampler) {\n      this._DiffuseEnvSampler = this.makeCube({\n        id: 'DiffuseEnvSampler',\n        getTextureForFace: dir => loadImage(this.getTexUrl('diffuse', dir, 0)),\n        parameters: {\n          [GL.TEXTURE_WRAP_S]: GL.CLAMP_TO_EDGE,\n          [GL.TEXTURE_WRAP_T]: GL.CLAMP_TO_EDGE,\n          [GL.TEXTURE_MIN_FILTER]: GL.LINEAR,\n          [GL.TEXTURE_MAG_FILTER]: GL.LINEAR\n        }\n      });\n    }\n\n    return this._DiffuseEnvSampler;\n  }\n\n  getSpecularEnvSampler() {\n    if (!this._SpecularEnvSampler) {\n      this._SpecularEnvSampler = this.makeCube({\n        id: 'SpecularEnvSampler',\n        getTextureForFace: dir => {\n          const imageArray = [];\n          for (let lod = 0; lod <= this.specularMipLevels - 1; lod++) {\n            imageArray.push(loadImage(this.getTexUrl('specular', dir, lod)));\n          }\n          return imageArray;\n        },\n        parameters: {\n          [GL.TEXTURE_WRAP_S]: GL.CLAMP_TO_EDGE,\n          [GL.TEXTURE_WRAP_T]: GL.CLAMP_TO_EDGE,\n          [GL.TEXTURE_MIN_FILTER]: GL.LINEAR_MIPMAP_LINEAR,\n          [GL.TEXTURE_MAG_FILTER]: GL.LINEAR\n        }\n      });\n    }\n\n    return this._SpecularEnvSampler;\n  }\n\n  getBrdfTexture() {\n    if (!this._BrdfTexture) {\n      this._BrdfTexture = new Texture2D(this.gl, {\n        id: 'brdfLUT',\n        parameters: {\n          [GL.TEXTURE_WRAP_S]: GL.CLAMP_TO_EDGE,\n          [GL.TEXTURE_WRAP_T]: GL.CLAMP_TO_EDGE,\n          [GL.TEXTURE_MIN_FILTER]: GL.LINEAR,\n          [GL.TEXTURE_MAG_FILTER]: GL.LINEAR\n        },\n        // Texture2D accepts a promise that returns an image as data (Async Textures)\n        data: loadImage(this.brdfLutUrl)\n      });\n    }\n\n    return this._BrdfTexture;\n  }\n\n  delete() {\n    if (this._DiffuseEnvSampler) {\n      this._DiffuseEnvSampler.delete();\n      this._DiffuseEnvSampler = null;\n    }\n\n    if (this._SpecularEnvSampler) {\n      this._SpecularEnvSampler.delete();\n      this._SpecularEnvSampler = null;\n    }\n\n    if (this._BrdfTexture) {\n      this._BrdfTexture.delete();\n      this._BrdfTexture = null;\n    }\n  }\n}\n"],"file":"gltf-environment.js"}