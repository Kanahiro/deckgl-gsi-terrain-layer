{"version":3,"sources":["../../../../../src/modules/fp64/test/fp64-test-utils.js"],"names":["Buffer","Program","assembleShaders","fp64","initializeGL","initializeTexTarget","render","getGPUOutput","BUFFER_DATA","Float32Array","fp64ify","a","hi","Math","fround","lo","getFloat64","upper","random","pow","getRelativeError64","result","reference","reference64","result64","abs","getRelativeError","getBinaryShader","operation","getUnaryShader","FS_RENDER_VCOLOR","setupFloatTest","gl","glslFunc","binary","limit","op","b","expected","a_fp64","b_fp64","expected_fp64","vs","program","fs","modules","setBuffers","positions","target","data","size","setUniforms","ONE","ITERATIONS","EPSILON","testcase","t","idx0","gpu_result","relativeError","args","toPrecision","message","ok","comment","toString","end","canvas","document","createElement","width","height","window","onload","body","appendChild"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the 'Software'), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n// Special utility functions for df64 tests\n\n/* eslint-disable camelcase, prefer-template, max-len */\n/* global window, document, */\n\nimport {Buffer, Program} from '@luma.gl/webgl';\nimport {assembleShaders, fp64} from '@luma.gl/shadertools';\nimport {\n  initializeGL,\n  initializeTexTarget,\n  render,\n  getGPUOutput\n} from '../../../test/gpu-test-utils';\n\nconst BUFFER_DATA = new Float32Array([1, 1, -1, 1, 1, -1, -1, -1]);\n\nfunction fp64ify(a) {\n  const hi = Math.fround(a);\n  const lo = a - Math.fround(a);\n  return new Float32Array([hi, lo]);\n}\n\nfunction getFloat64(upper = 256) {\n  return Math.random() * Math.pow(2.0, (Math.random() - 0.5) * upper);\n}\n\nexport function getRelativeError64(result, reference) {\n  const reference64 = reference[0] + reference[1];\n  const result64 = result[0] + result[1];\n  // When refrence valu is < 1, dividing with it increases total value of difference.\n  if (reference64 < 1) {\n    return Math.abs(reference64 - result64);\n  }\n  return Math.abs((reference64 - result64) / reference64);\n}\n\nexport function getRelativeError(result, reference) {\n  return Math.abs((reference - result) / reference);\n}\n\nfunction getBinaryShader(operation) {\n  return `\\\nattribute vec3 positions;\nuniform vec2 a;\nuniform vec2 b;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_Position = vec4(positions, 1.0);\n  vec2 result = ${operation}(a, b);\n  vColor = vec4(result.x, result.y, 0.0, 1.0);\n}\n`;\n}\n\nfunction getUnaryShader(operation) {\n  return `\\\nattribute vec3 positions;\nuniform vec2 a;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_Position = vec4(positions, 1.0);\n  vec2 result = ${operation}(a);\n  vColor = vec4(result.x, result.y, 0.0, 1.0);\n}\n`;\n}\n\nconst FS_RENDER_VCOLOR = `\\\nprecision highp float;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_FragColor = vColor;\n}\n`;\n\nfunction setupFloatTest(gl, {glslFunc, binary = false, limit = 256, op}) {\n  const a = getFloat64(limit);\n  const b = getFloat64(limit);\n  const expected = op(a, b);\n\n  const a_fp64 = fp64ify(a);\n  const b_fp64 = fp64ify(b);\n  const expected_fp64 = fp64ify(expected);\n\n  const vs = binary ? getBinaryShader(glslFunc) : getUnaryShader(glslFunc);\n\n  const program = new Program(\n    gl,\n    assembleShaders(gl, {\n      vs,\n      fs: FS_RENDER_VCOLOR,\n      modules: [fp64]\n    })\n  );\n\n  program\n    .setBuffers({\n      positions: new Buffer(gl, {target: gl.ARRAY_BUFFER, data: BUFFER_DATA, size: 2})\n    })\n    .setUniforms({\n      a: a_fp64,\n      b: b_fp64,\n      ONE: 1.0\n    });\n\n  return {a, b, expected, a_fp64, b_fp64, expected_fp64, program};\n}\n\nconst ITERATIONS = 10;\nconst EPSILON = 1e-14;\n\nexport function testcase(gl, {glslFunc, binary, op, limit = 256, t}) {\n  for (let idx0 = 0; idx0 < ITERATIONS; idx0++) {\n    const {a, b, a_fp64, b_fp64, expected_fp64} = setupFloatTest(gl, {\n      glslFunc,\n      binary,\n      op,\n      limit\n    });\n    render(gl);\n    const gpu_result = getGPUOutput(gl);\n    const relativeError = getRelativeError64(gpu_result, expected_fp64);\n    const args = binary ? `(${a.toPrecision(2)}, ${b.toPrecision(2)})` : `(${a.toPrecision(2)})`;\n    const message = `${glslFunc}${args}: error=${relativeError}, within ${EPSILON}`;\n    t.ok(relativeError < EPSILON, message);\n    if (relativeError >= EPSILON) {\n      t.comment(` (tested ${a_fp64.toString()}, ${b_fp64.toString()})`);\n    }\n  }\n  t.end();\n}\n\n// Main entrance\nconst canvas = document.createElement('canvas');\ncanvas.width = 16;\ncanvas.height = 16;\n\nexport const gl = initializeGL(canvas);\ninitializeTexTarget(gl);\n\nwindow.onload = () => {\n  document.body.appendChild(canvas);\n};\n"],"file":"fp64-test-utils.js"}