{"version":3,"sources":["../../../../src/lib/encoders/encode-image.js"],"names":["global","getImageSize","_encodeImageNode","encodeImage","image","options","type","mimeType","encodeImageInBrowser","qualityParamSupported","jpegQuality","width","height","canvas","document","createElement","drawImageToCanvas","Promise","resolve","reject","toBlob","error","blob","arrayBuffer","x","y","ImageBitmap","context","getContext","transferFromImageBitmap","data","clampedArray","Uint8ClampedArray","imageData","ImageData","putImageData","drawImage"],"mappings":"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","sourcesContent":["// Image loading/saving for browser and Node.js\n/* global document, ImageBitmap, ImageData */\nimport {global} from '../utils/globals';\nimport {getImageSize} from '../category-api/parsed-image-api';\n\n// @ts-ignore TS2339: Property does not exist on type\nconst {_encodeImageNode} = global;\n\nexport async function encodeImage(image, options) {\n  options = options || {};\n  options.image = options.image || {};\n\n  return _encodeImageNode\n    ? _encodeImageNode(image, {type: options.image.mimeType})\n    : encodeImageInBrowser(image, options);\n}\n\n// In case we get exceptions from canvas.toBlob(resolve, type, quality)\nlet qualityParamSupported = true;\n\n/**\n *\n * @param image\n * @param options\n * @note Based on canvas.toBlob\n * @see https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob\n */\nasync function encodeImageInBrowser(image, options) {\n  const {mimeType, jpegQuality} = options.image;\n\n  const {width, height} = getImageSize(image);\n\n  // create a canvas and resize it to the size of our image\n  const canvas = document.createElement('canvas');\n  canvas.width = width;\n  canvas.height = height;\n\n  drawImageToCanvas(image, canvas);\n\n  // The actual encoding is done asynchronously with `canvas.toBlob()`\n  const blob = await new Promise((resolve, reject) => {\n    // get it back as a Blob\n    if (jpegQuality && qualityParamSupported) {\n      try {\n        canvas.toBlob(resolve, mimeType, jpegQuality);\n        return;\n      } catch (error) {\n        qualityParamSupported = false;\n      }\n    }\n    canvas.toBlob(resolve, mimeType);\n  });\n\n  return await blob.arrayBuffer();\n}\n\nfunction drawImageToCanvas(image, canvas, x = 0, y = 0) {\n  // Try optimized path for ImageBitmaps via bitmaprenderer context\n  if (x === 0 && y === 0 && typeof ImageBitmap !== 'undefined' && image instanceof ImageBitmap) {\n    const context = canvas.getContext('bitmaprenderer');\n    if (context) {\n      // transfer the ImageBitmap to it\n      context.transferFromImageBitmap(image);\n      return canvas;\n    }\n  }\n\n  // Available on most platforms, except IE11 and Andriod WebViews...\n  const context = canvas.getContext('2d');\n  if (image.data) {\n    // ImageData constructor expects clamped array even though getImageData does not return a clamped array...\n    const clampedArray = new Uint8ClampedArray(image.data);\n    const imageData = new ImageData(clampedArray, image.width, image.height);\n    context.putImageData(imageData, 0, 0);\n    return canvas;\n  }\n\n  // Fall back to generic image/image bitmap rendering path\n  context.drawImage(image, 0, 0);\n  return canvas;\n}\n"],"file":"encode-image.js"}