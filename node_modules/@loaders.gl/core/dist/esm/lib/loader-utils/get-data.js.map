{"version":3,"sources":["../../../../src/lib/loader-utils/get-data.js"],"names":["concatenateChunksAsync","isResponse","isReadableStream","isAsyncIterable","isIterable","isIterator","isBlob","isBuffer","makeIterator","checkResponse","makeResponse","ERR_DATA","getArrayBufferOrStringFromDataSync","data","loader","text","ArrayBuffer","arrayBuffer","binary","textDecoder","TextDecoder","decode","isView","buffer","byteLength","length","byteOffset","slice","Error","getArrayBufferOrStringFromData","isArrayBuffer","response","getAsyncIteratorFromData","body","Symbol","asyncIterator","getIteratorFromData","oneChunk","iterator","getReadableStream"],"mappings":";;AACA,SAAQA,sBAAR,QAAqC,0BAArC;AACA,SACEC,UADF,EAEEC,gBAFF,EAGEC,eAHF,EAIEC,UAJF,EAKEC,UALF,EAMEC,MANF,EAOEC,QAPF,QAQO,gCARP;AASA,SAAQC,YAAR,QAA2B,kDAA3B;AACA,SAAQC,aAAR,EAAuBC,YAAvB,QAA0C,yBAA1C;AAEA,IAAMC,QAAQ,GAAG,mCAAjB;AAGA,OAAO,SAASC,kCAAT,CAA4CC,IAA5C,EAAkDC,MAAlD,EAA0D;AAC/D,MAAIA,MAAM,CAACC,IAAP,IAAe,OAAOF,IAAP,KAAgB,QAAnC,EAA6C;AAC3C,WAAOA,IAAP;AACD;;AAED,MAAIA,IAAI,YAAYG,WAApB,EAAiC;AAC/B,QAAMC,WAAW,GAAGJ,IAApB;;AACA,QAAIC,MAAM,CAACC,IAAP,IAAe,CAACD,MAAM,CAACI,MAA3B,EAAmC;AACjC,UAAMC,WAAW,GAAG,IAAIC,WAAJ,CAAgB,MAAhB,CAApB;AACA,aAAOD,WAAW,CAACE,MAAZ,CAAmBJ,WAAnB,CAAP;AACD;;AACD,WAAOA,WAAP;AACD;;AAGD,MAAID,WAAW,CAACM,MAAZ,CAAmBT,IAAnB,KAA4BN,QAAQ,CAACM,IAAD,CAAxC,EAAgD;AAE9C,QAAIC,MAAM,CAACC,IAAP,IAAe,CAACD,MAAM,CAACI,MAA3B,EAAmC;AACjC,UAAMC,YAAW,GAAG,IAAIC,WAAJ,CAAgB,MAAhB,CAApB;;AACA,aAAOD,YAAW,CAACE,MAAZ,CAAmBR,IAAnB,CAAP;AACD;;AAED,QAAII,YAAW,GAAGJ,IAAI,CAACU,MAAvB;AAKA,QAAMC,UAAU,GAAGX,IAAI,CAACW,UAAL,IAAmBX,IAAI,CAACY,MAA3C;;AACA,QAAIZ,IAAI,CAACa,UAAL,KAAoB,CAApB,IAAyBF,UAAU,KAAKP,YAAW,CAACO,UAAxD,EAAoE;AAElEP,MAAAA,YAAW,GAAGA,YAAW,CAACU,KAAZ,CAAkBd,IAAI,CAACa,UAAvB,EAAmCb,IAAI,CAACa,UAAL,GAAkBF,UAArD,CAAd;AACD;;AACD,WAAOP,YAAP;AACD;;AAED,QAAM,IAAIW,KAAJ,CAAUjB,QAAV,CAAN;AACD;AAGD,gBAAsBkB,8BAAtB;AAAA;AAAA;;;+EAAO,iBAA8ChB,IAA9C,EAAoDC,MAApD;AAAA;AAAA;AAAA;AAAA;AAAA;AACCgB,YAAAA,aADD,GACiBjB,IAAI,YAAYG,WAAhB,IAA+BA,WAAW,CAACM,MAAZ,CAAmBT,IAAnB,CADhD;;AAAA,kBAED,OAAOA,IAAP,KAAgB,QAAhB,IAA4BiB,aAF3B;AAAA;AAAA;AAAA;;AAAA,8CAGIlB,kCAAkC,CAACC,IAAD,EAAOC,MAAP,CAHtC;;AAAA;AAAA,iBAODR,MAAM,CAACO,IAAD,CAPL;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAQUH,YAAY,CAACG,IAAD,CARtB;;AAAA;AAQHA,YAAAA,IARG;;AAAA;AAAA,iBAWDZ,UAAU,CAACY,IAAD,CAXT;AAAA;AAAA;AAAA;;AAYGkB,YAAAA,QAZH,GAYclB,IAZd;AAAA;AAAA,mBAaGJ,aAAa,CAACsB,QAAD,CAbhB;;AAAA;AAAA,iBAcIjB,MAAM,CAACI,MAdX;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAc0Ba,QAAQ,CAACd,WAAT,EAd1B;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,mBAcyDc,QAAQ,CAAChB,IAAT,EAdzD;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAiBL,gBAAIb,gBAAgB,CAACW,IAAD,CAApB,EAA4B;AAC1BA,cAAAA,IAAI,GAAGL,YAAY,CAACK,IAAD,CAAnB;AACD;;AAnBI,kBAqBDT,UAAU,CAACS,IAAD,CAAV,IAAoBV,eAAe,CAACU,IAAD,CArBlC;AAAA;AAAA;AAAA;;AAAA,8CAuBIb,sBAAsB,CAACa,IAAD,CAvB1B;;AAAA;AAAA,kBA0BC,IAAIe,KAAJ,CAAUjB,QAAV,CA1BD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AA6BP,gBAAsBqB,wBAAtB;AAAA;AAAA;;;yEAAO,kBAAwCnB,IAAxC;AAAA;AAAA;AAAA;AAAA;AAAA,iBACDR,UAAU,CAACQ,IAAD,CADT;AAAA;AAAA;AAAA;;AAAA,8CAEIA,IAFJ;;AAAA;AAAA,iBAKDZ,UAAU,CAACY,IAAD,CALT;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAOGJ,aAAa,CAACI,IAAD,CAPhB;;AAAA;AAAA,8CASIL,YAAY,CAACK,IAAI,CAACoB,IAAN,CAThB;;AAAA;AAAA,kBAYD3B,MAAM,CAACO,IAAD,CAAN,IAAgBX,gBAAgB,CAACW,IAAD,CAZ/B;AAAA;AAAA;AAAA;;AAAA,8CAaIL,YAAY,CAACK,IAAD,CAbhB;;AAAA;AAAA,iBAgBDV,eAAe,CAACU,IAAD,CAhBd;AAAA;AAAA;AAAA;;AAAA,8CAiBIA,IAAI,CAACqB,MAAM,CAACC,aAAR,CAAJ,EAjBJ;;AAAA;AAAA,8CAoBEC,mBAAmB,CAACvB,IAAD,CApBrB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAuBP,SAASuB,mBAAT,CAA6BvB,IAA7B,EAAmC;AAEjC,MAAIG,WAAW,CAACM,MAAZ,CAAmBT,IAAnB,CAAJ,EAA8B;AAC5B,WAAO,yBAAC,SAAUwB,QAAV;AAAA;AAAA;AAAA;AAAA;AAAA;AACN,qBAAMxB,IAAI,CAACU,MAAX;;AADM;AAAA;AAAA;AAAA;AAAA;AAAA,SAAUc,QAAV;AAAA,KAAD,GAAP;AAGD;;AAED,MAAIxB,IAAI,YAAYG,WAApB,EAAiC;AAC/B,WAAO,yBAAC,SAAUqB,QAAV;AAAA;AAAA;AAAA;AAAA;AAAA;AACN,qBAAMxB,IAAN;;AADM;AAAA;AAAA;AAAA;AAAA;AAAA,SAAUwB,QAAV;AAAA,KAAD,GAAP;AAGD;;AAED,MAAIhC,UAAU,CAACQ,IAAD,CAAd,EAAsB;AACpB,WAAOA,IAAP;AACD;;AAED,MAAIT,UAAU,CAACS,IAAD,CAAd,EAAsB;AACpB,WAAOA,IAAI,CAACqB,MAAM,CAACI,QAAR,CAAJ,EAAP;AACD;;AAED,QAAM,IAAIV,KAAJ,CAAUjB,QAAV,CAAN;AACD;;AAED,gBAAsB4B,iBAAtB;AAAA;AAAA;;;kEAAO,kBAAiC1B,IAAjC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBACDX,gBAAgB,CAACW,IAAD,CADf;AAAA;AAAA;AAAA;;AAAA,8CAEIA,IAFJ;;AAAA;AAAA,iBAIDZ,UAAU,CAACY,IAAD,CAJT;AAAA;AAAA;AAAA;;AAAA,8CAKIA,IAAI,CAACoB,IALT;;AAAA;AAAA;AAAA,mBAOkBvB,YAAY,CAACG,IAAD,CAP9B;;AAAA;AAOCkB,YAAAA,QAPD;AAAA,8CAQEA,QAAQ,CAACE,IARX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["/* global TextDecoder */\nimport {concatenateChunksAsync} from '@loaders.gl/loader-utils';\nimport {\n  isResponse,\n  isReadableStream,\n  isAsyncIterable,\n  isIterable,\n  isIterator,\n  isBlob,\n  isBuffer\n} from '../../javascript-utils/is-type';\nimport {makeIterator} from '../../iterator-utils/make-iterator/make-iterator';\nimport {checkResponse, makeResponse} from '../utils/response-utils';\n\nconst ERR_DATA = 'Cannot convert supplied data type';\n\n// eslint-disable-next-line complexity\nexport function getArrayBufferOrStringFromDataSync(data, loader) {\n  if (loader.text && typeof data === 'string') {\n    return data;\n  }\n\n  if (data instanceof ArrayBuffer) {\n    const arrayBuffer = data;\n    if (loader.text && !loader.binary) {\n      const textDecoder = new TextDecoder('utf8');\n      return textDecoder.decode(arrayBuffer);\n    }\n    return arrayBuffer;\n  }\n\n  // We may need to handle offsets\n  if (ArrayBuffer.isView(data) || isBuffer(data)) {\n    // TextDecoder is invoked on typed arrays and will handle offsets\n    if (loader.text && !loader.binary) {\n      const textDecoder = new TextDecoder('utf8');\n      return textDecoder.decode(data);\n    }\n\n    let arrayBuffer = data.buffer;\n\n    // Since we are returning the underlying arrayBuffer, we must create a new copy\n    // if this typed array / Buffer is a partial view into the ArryayBuffer\n    // TODO - this is a potentially unnecessary copy\n    const byteLength = data.byteLength || data.length;\n    if (data.byteOffset !== 0 || byteLength !== arrayBuffer.byteLength) {\n      // console.warn(`loaders.gl copying arraybuffer of length ${byteLength}`);\n      arrayBuffer = arrayBuffer.slice(data.byteOffset, data.byteOffset + byteLength);\n    }\n    return arrayBuffer;\n  }\n\n  throw new Error(ERR_DATA);\n}\n\n// Convert async iterator to a promise\nexport async function getArrayBufferOrStringFromData(data, loader) {\n  const isArrayBuffer = data instanceof ArrayBuffer || ArrayBuffer.isView(data);\n  if (typeof data === 'string' || isArrayBuffer) {\n    return getArrayBufferOrStringFromDataSync(data, loader);\n  }\n\n  // Blobs and files are FileReader compatible\n  if (isBlob(data)) {\n    data = await makeResponse(data);\n  }\n\n  if (isResponse(data)) {\n    const response = data;\n    await checkResponse(response);\n    return loader.binary ? await response.arrayBuffer() : await response.text();\n  }\n\n  if (isReadableStream(data)) {\n    data = makeIterator(data);\n  }\n\n  if (isIterable(data) || isAsyncIterable(data)) {\n    // Assume arrayBuffer iterator - attempt to concatenate\n    return concatenateChunksAsync(data);\n  }\n\n  throw new Error(ERR_DATA);\n}\n\nexport async function getAsyncIteratorFromData(data) {\n  if (isIterator(data)) {\n    return data;\n  }\n\n  if (isResponse(data)) {\n    // Note Since this function is not async, we currently can't load error message, just status\n    await checkResponse(data);\n    // TODO - bug in polyfill, body can be a Promise under Node.js\n    return makeIterator(data.body);\n  }\n\n  if (isBlob(data) || isReadableStream(data)) {\n    return makeIterator(data);\n  }\n\n  if (isAsyncIterable(data)) {\n    return data[Symbol.asyncIterator]();\n  }\n\n  return getIteratorFromData(data);\n}\n\nfunction getIteratorFromData(data) {\n  // generate an iterator that emits a single chunk\n  if (ArrayBuffer.isView(data)) {\n    return (function* oneChunk() {\n      yield data.buffer;\n    })();\n  }\n\n  if (data instanceof ArrayBuffer) {\n    return (function* oneChunk() {\n      yield data;\n    })();\n  }\n\n  if (isIterator(data)) {\n    return data;\n  }\n\n  if (isIterable(data)) {\n    return data[Symbol.iterator]();\n  }\n\n  throw new Error(ERR_DATA);\n}\n\nexport async function getReadableStream(data) {\n  if (isReadableStream(data)) {\n    return data;\n  }\n  if (isResponse(data)) {\n    return data.body;\n  }\n  const response = await makeResponse(data);\n  return response.body;\n}\n"],"file":"get-data.js"}