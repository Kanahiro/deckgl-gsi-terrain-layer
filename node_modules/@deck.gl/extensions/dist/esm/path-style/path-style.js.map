{"version":3,"sources":["../../../src/path-style/path-style.js"],"names":["LayerExtension","_mergeShaders","mergeShaders","dashShaders","offsetShaders","dist","defaultProps","getDashArray","type","value","getOffset","dashJustified","PathStyleExtension","dash","offset","highPrecisionDash","layer","state","pathTesselator","extension","isEnabled","result","opts","context","attributeManager","getAttributeManager","enabled","addInstanced","instanceDashArrays","size","accessor","instanceDashOffsets","transform","getDashOffsets","bind","instanceOffsets","params","uniforms","dashAlignMode","props","model","setUniforms","path","positionSize","positionFormat","isNested","Array","isArray","geometrySize","length","p","prevP","i","slice","projectPosition","extensionName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {LayerExtension, _mergeShaders as mergeShaders} from '@deck.gl/core';\nimport {dashShaders, offsetShaders} from './shaders.glsl';\nimport {dist} from 'gl-matrix/vec3';\n\nconst defaultProps = {\n  getDashArray: {type: 'accessor', value: [0, 0]},\n  getOffset: {type: 'accessor', value: 0},\n  dashJustified: false\n};\n\nexport default class PathStyleExtension extends LayerExtension {\n  constructor({dash = false, offset = false, highPrecisionDash = false} = {}) {\n    super({dash: dash || highPrecisionDash, offset, highPrecisionDash});\n  }\n\n  isEnabled(layer) {\n    return layer.state.pathTesselator;\n  }\n\n  getShaders(extension) {\n    if (!extension.isEnabled(this)) {\n      return null;\n    }\n\n    // Merge shader injection\n    let result = {};\n    if (extension.opts.dash) {\n      result = mergeShaders(result, dashShaders);\n    }\n    if (extension.opts.offset) {\n      result = mergeShaders(result, offsetShaders);\n    }\n\n    return result;\n  }\n\n  initializeState(context, extension) {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager || !extension.isEnabled(this)) {\n      // This extension only works with the PathLayer\n      return;\n    }\n\n    extension.enabled = true;\n\n    if (extension.opts.dash) {\n      attributeManager.addInstanced({\n        instanceDashArrays: {size: 2, accessor: 'getDashArray'}\n      });\n    }\n    if (extension.opts.highPrecisionDash) {\n      attributeManager.addInstanced({\n        instanceDashOffsets: {\n          size: 1,\n          accessor: 'getPath',\n          transform: extension.getDashOffsets.bind(this)\n        }\n      });\n    }\n    if (extension.opts.offset) {\n      attributeManager.addInstanced({\n        instanceOffsets: {size: 1, accessor: 'getOffset'}\n      });\n    }\n  }\n\n  updateState(params, extension) {\n    if (!extension.isEnabled(this)) {\n      return;\n    }\n\n    const uniforms = {};\n\n    if (extension.opts.dash) {\n      uniforms.dashAlignMode = this.props.dashJustified ? 1 : 0;\n    }\n\n    this.state.model.setUniforms(uniforms);\n  }\n\n  getDashOffsets(path) {\n    const result = [0];\n    const positionSize = this.props.positionFormat === 'XY' ? 2 : 3;\n    const isNested = Array.isArray(path[0]);\n    const geometrySize = isNested ? path.length : path.length / positionSize;\n\n    let p;\n    let prevP;\n    for (let i = 0; i < geometrySize - 1; i++) {\n      p = isNested ? path[i] : path.slice(i * positionSize, i * positionSize + positionSize);\n      p = this.projectPosition(p);\n\n      if (i > 0) {\n        result[i] = result[i - 1] + dist(prevP, p);\n      }\n\n      prevP = p;\n    }\n    return result;\n  }\n}\n\nPathStyleExtension.extensionName = 'PathStyleExtension';\nPathStyleExtension.defaultProps = defaultProps;\n"],"file":"path-style.js"}