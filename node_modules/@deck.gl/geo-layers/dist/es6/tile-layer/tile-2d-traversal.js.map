{"version":3,"sources":["../../../src/tile-layer/tile-2d-traversal.js"],"names":["CullingVolume","Plane","AxisAlignedBoundingBox","WebMercatorViewport","fitBounds","TILE_SIZE","MAX_MAPS","OSMNode","constructor","x","y","z","children","_children","update","params","viewport","cullingVolume","elevationBounds","minZ","maxZ","offset","boundingVolume","getBoundingVolume","isInside","computeVisibility","childVisible","distance","distanceTo","cameraPosition","scale","height","Math","floor","log2","selected","child","getSelected","result","push","node","zRange","worldOffset","pow","extent","originX","originY","getOSMTileIndices","bbox","getBounds","longitude","latitude","zoom","width","bounds","repeat","planes","Object","values","getFrustumPlanes","map","normal","clone","negate","unitsPerMeter","distanceScales","elevationMin","elevationMax","pitch","root","traversalParams","subViewports","length"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport {CullingVolume, Plane, AxisAlignedBoundingBox} from '@math.gl/culling';\nimport {WebMercatorViewport} from '@deck.gl/core';\nimport {fitBounds} from '@math.gl/web-mercator';\n\nconst TILE_SIZE = 512;\n// number of world copies to check\nconst MAX_MAPS = 3;\n\nclass OSMNode {\n  constructor(x, y, z) {\n    this.x = x;\n    this.y = y;\n    this.z = z;\n  }\n\n  get children() {\n    if (!this._children) {\n      const x = this.x * 2;\n      const y = this.y * 2;\n      const z = this.z + 1;\n      this._children = [\n        new OSMNode(x, y, z),\n        new OSMNode(x, y + 1, z),\n        new OSMNode(x + 1, y, z),\n        new OSMNode(x + 1, y + 1, z)\n      ];\n    }\n    return this._children;\n  }\n\n  update(params) {\n    const {viewport, cullingVolume, elevationBounds, minZ, maxZ, offset} = params;\n    const boundingVolume = this.getBoundingVolume(elevationBounds, offset);\n\n    // First, check if this tile is visible\n    const isInside = cullingVolume.computeVisibility(boundingVolume);\n    if (isInside < 0) {\n      return false;\n    }\n\n    // Avoid loading overlapping tiles - if a descendant is requested, do not request the ancester\n    if (!this.childVisible) {\n      let {z} = this;\n      if (z < maxZ && z >= minZ) {\n        // Adjust LOD\n        // If the tile is far enough from the camera, accept a lower zoom level\n        const distance =\n          (boundingVolume.distanceTo(viewport.cameraPosition) * viewport.scale) / viewport.height;\n        z += Math.floor(Math.log2(distance));\n      }\n      if (z >= maxZ) {\n        // LOD is acceptable\n        this.selected = true;\n        return true;\n      }\n    }\n\n    // LOD is not enough, recursively test child tiles\n    this.selected = false;\n    this.childVisible = true;\n    for (const child of this.children) {\n      child.update(params);\n    }\n    return true;\n  }\n\n  getSelected(result = []) {\n    if (this.selected) {\n      result.push(this);\n    }\n    if (this._children) {\n      for (const node of this._children) {\n        node.getSelected(result);\n      }\n    }\n    return result;\n  }\n\n  getBoundingVolume(zRange, worldOffset) {\n    const scale = Math.pow(2, this.z);\n    const extent = TILE_SIZE / scale;\n    const originX = this.x * extent + worldOffset * TILE_SIZE;\n    // deck's common space is y-flipped\n    const originY = TILE_SIZE - (this.y + 1) * extent;\n\n    return new AxisAlignedBoundingBox(\n      [originX, originY, zRange[0]],\n      [originX + extent, originY + extent, zRange[1]]\n    );\n  }\n}\n\nexport function getOSMTileIndices(viewport, maxZ, zRange) {\n  if (!(viewport instanceof WebMercatorViewport)) {\n    const bbox = viewport.getBounds();\n    // The width and height here are arbitrary - they just need to form a reasonable aspect ratio\n    // so that we don't get too many world copies\n    const {longitude, latitude, zoom} = fitBounds({\n      width: 100,\n      height: 100,\n      bounds: [[bbox[0], bbox[1]], [bbox[2], bbox[3]]]\n    });\n\n    viewport = new WebMercatorViewport({\n      width: 100,\n      height: 100,\n      longitude,\n      latitude,\n      zoom,\n      repeat: true\n    });\n  }\n\n  // Get the culling volume of the current camera\n  const planes = Object.values(viewport.getFrustumPlanes()).map(\n    ({normal, distance}) => new Plane(normal.clone().negate(), distance)\n  );\n  const cullingVolume = new CullingVolume(planes);\n\n  // Project zRange from meters to common space\n  const unitsPerMeter = viewport.distanceScales.unitsPerMeter[2];\n  const elevationMin = (zRange && zRange[0] * unitsPerMeter) || 0;\n  const elevationMax = (zRange && zRange[1] * unitsPerMeter) || 0;\n\n  // Always load at the current zoom level if pitch is small\n  const minZ = viewport.pitch <= 60 ? maxZ : 0;\n\n  const root = new OSMNode(0, 0, 0);\n  const traversalParams = {\n    viewport,\n    cullingVolume,\n    elevationBounds: [elevationMin, elevationMax],\n    minZ,\n    maxZ,\n    // num. of worlds from the center. For repeated maps\n    offset: 0\n  };\n\n  root.update(traversalParams);\n\n  if (viewport.subViewports && viewport.subViewports.length > 1) {\n    // Check worlds in repeated maps\n    traversalParams.offset = -1;\n    while (root.update(traversalParams)) {\n      if (--traversalParams.offset < -MAX_MAPS) {\n        break;\n      }\n    }\n    traversalParams.offset = 1;\n    while (root.update(traversalParams)) {\n      if (++traversalParams.offset > MAX_MAPS) {\n        break;\n      }\n    }\n  }\n\n  return root.getSelected();\n}\n"],"file":"tile-2d-traversal.js"}