{"version":3,"sources":["../../../src/tile-3d-layer/tile-3d-layer.js"],"names":["scratchOffset","Vector3","defaultProps","getPointColor","pointSize","data","loadOptions","loader","Tiles3DLoader","onTilesetLoad","tileset3d","onTileLoad","tileHeader","onTileUnload","onTileError","tile","message","url","Tile3DLayer","props","log","removed","state","layerMap","changeFlags","somethingChanged","oldProps","_loadTileset","viewportChanged","_updateTileset","info","sourceLayer","layerId","id","substr","substring","length","tileId","indexOf","object","tilesetUrl","options","preload","preloadOptions","Object","assign","tilesetJson","Tileset3D","_onTileLoad","bind","_onTileUnload","onTileLoadFail","setState","setNeedsUpdate","context","timeline","viewport","frameNumber","update","tilesetChanged","content","type","TILE_TYPE","POINTCLOUD","_createPointCloudTileLayer","SCENEGRAPH","_create3DModelTileLayer","MESH","_createSimpleMeshLayer","Error","attributes","pointCount","constantRGBA","cartographicOrigin","modelMatrix","positions","normals","colors","SubLayerClass","getSubLayerClass","PointCloudLayer","getSubLayerProps","header","vertexCount","POSITION","NORMAL","COLOR_0","coordinateSystem","COORDINATE_SYSTEM","METER_OFFSETS","coordinateOrigin","getColor","gltf","instances","ScenegraphLayer","_lighting","scenegraph","getTransformMatrix","instance","getPosition","texture","texCoords","Float32Array","value","i","copy","subarray","set","geometry","Geometry","drawMode","SimpleMeshLayer","mesh","tiles","map","layer","selected","_create3DTileLayer","visible","clone","filter","Boolean","CompositeLayer","layerName"],"mappings":"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","sourcesContent":["import {Vector3} from 'math.gl';\nimport GL from '@luma.gl/constants';\nimport {Geometry} from '@luma.gl/core';\nimport {COORDINATE_SYSTEM, CompositeLayer} from '@deck.gl/core';\nimport {PointCloudLayer} from '@deck.gl/layers';\nimport {ScenegraphLayer, SimpleMeshLayer} from '@deck.gl/mesh-layers';\nimport {log} from '@deck.gl/core';\n\nimport {load} from '@loaders.gl/core';\nimport {Tileset3D, TILE_TYPE} from '@loaders.gl/tiles';\nimport {Tiles3DLoader} from '@loaders.gl/3d-tiles';\n\nconst scratchOffset = new Vector3();\n\nconst defaultProps = {\n  getPointColor: [0, 0, 0],\n  pointSize: 1.0,\n\n  data: null,\n  loadOptions: {},\n  loader: Tiles3DLoader,\n\n  onTilesetLoad: tileset3d => {},\n  onTileLoad: tileHeader => {},\n  onTileUnload: tileHeader => {},\n  onTileError: (tile, message, url) => {}\n};\n\nexport default class Tile3DLayer extends CompositeLayer {\n  initializeState() {\n    if ('onTileLoadFail' in this.props) {\n      log.removed('onTileLoadFail', 'onTileError')();\n    }\n    // prop verification\n    this.state = {\n      layerMap: {},\n      tileset3d: null\n    };\n  }\n\n  shouldUpdateState({changeFlags}) {\n    return changeFlags.somethingChanged;\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    if (props.data && props.data !== oldProps.data) {\n      this._loadTileset(props.data);\n    }\n\n    if (changeFlags.viewportChanged) {\n      const {tileset3d} = this.state;\n      this._updateTileset(tileset3d);\n    }\n  }\n\n  getPickingInfo({info, sourceLayer}) {\n    const {layerMap} = this.state;\n    const layerId = sourceLayer && sourceLayer.id;\n    if (layerId) {\n      // layerId: this.id-[scenegraph|pointcloud]-tileId\n      const substr = layerId.substring(this.id.length + 1);\n      const tileId = substr.substring(substr.indexOf('-') + 1);\n      info.object = layerMap[tileId] && layerMap[tileId].tile;\n    }\n\n    return info;\n  }\n\n  async _loadTileset(tilesetUrl) {\n    const {loader, loadOptions} = this.props;\n    const options = {...loadOptions};\n    if (loader.preload) {\n      const preloadOptions = await loader.preload(tilesetUrl, loadOptions);\n      Object.assign(options, preloadOptions);\n    }\n    const tilesetJson = await load(tilesetUrl, loader, options);\n\n    const tileset3d = new Tileset3D(tilesetJson, {\n      onTileLoad: this._onTileLoad.bind(this),\n      onTileUnload: this._onTileUnload.bind(this),\n      onTileLoadFail: this.props.onTileError,\n      ...options\n    });\n\n    this.setState({\n      tileset3d,\n      layerMap: {}\n    });\n\n    this._updateTileset(tileset3d);\n    this.props.onTilesetLoad(tileset3d);\n  }\n\n  _onTileLoad(tileHeader) {\n    this.props.onTileLoad(tileHeader);\n    this._updateTileset(this.state.tileset3d);\n    this.setNeedsUpdate();\n  }\n\n  _onTileUnload(tileHeader) {\n    // Was cleaned up from tileset cache. We no longer need to track it.\n    delete this.state.layerMap[tileHeader.id];\n    this.props.onTileUnload(tileHeader);\n  }\n\n  _updateTileset(tileset3d) {\n    const {timeline, viewport} = this.context;\n    if (!timeline || !viewport || !tileset3d) {\n      return;\n    }\n    const frameNumber = tileset3d.update(viewport);\n    const tilesetChanged = this.state.frameNumber !== frameNumber;\n    if (tilesetChanged) {\n      this.setState({frameNumber});\n    }\n  }\n\n  _create3DTileLayer(tileHeader) {\n    if (!tileHeader.content) {\n      return null;\n    }\n\n    switch (tileHeader.type) {\n      case TILE_TYPE.POINTCLOUD:\n        return this._createPointCloudTileLayer(tileHeader);\n      case TILE_TYPE.SCENEGRAPH:\n        return this._create3DModelTileLayer(tileHeader);\n      case TILE_TYPE.MESH:\n        return this._createSimpleMeshLayer(tileHeader);\n      default:\n        throw new Error(`Tile3DLayer: Failed to render layer of type ${tileHeader.content.type}`);\n    }\n  }\n\n  _createPointCloudTileLayer(tileHeader) {\n    const {\n      attributes,\n      pointCount,\n      constantRGBA,\n      cartographicOrigin,\n      modelMatrix\n    } = tileHeader.content;\n    const {positions, normals, colors} = attributes;\n\n    if (!positions) {\n      return null;\n    }\n\n    const {pointSize, getPointColor} = this.props;\n    const SubLayerClass = this.getSubLayerClass('pointcloud', PointCloudLayer);\n    return new SubLayerClass(\n      {\n        pointSize\n      },\n      this.getSubLayerProps({\n        id: 'pointcloud'\n      }),\n      {\n        id: `${this.id}-pointcloud-${tileHeader.id}`,\n        data: {\n          header: {\n            vertexCount: pointCount\n          },\n          attributes: {\n            POSITION: positions,\n            NORMAL: normals,\n            COLOR_0: colors\n          }\n        },\n        coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,\n        coordinateOrigin: cartographicOrigin,\n        modelMatrix,\n\n        getColor: constantRGBA || getPointColor\n      }\n    );\n  }\n\n  _create3DModelTileLayer(tileHeader) {\n    const {gltf, instances, cartographicOrigin, modelMatrix} = tileHeader.content;\n\n    const SubLayerClass = this.getSubLayerClass('scenegraph', ScenegraphLayer);\n\n    return new SubLayerClass(\n      {\n        _lighting: 'pbr'\n      },\n      this.getSubLayerProps({\n        id: 'scenegraph'\n      }),\n      {\n        id: `${this.id}-scenegraph-${tileHeader.id}`,\n        data: instances || [{}],\n        scenegraph: gltf,\n\n        coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,\n        coordinateOrigin: cartographicOrigin,\n        modelMatrix,\n        getTransformMatrix: instance => instance.modelMatrix,\n        getPosition: instance => [0, 0, 0]\n      }\n    );\n  }\n\n  _createSimpleMeshLayer(tileHeader) {\n    const content = tileHeader.content;\n    const {attributes, modelMatrix, cartographicOrigin, texture} = content;\n    const {normals, texCoords} = attributes;\n    const positions = new Float32Array(attributes.positions.value.length);\n    for (let i = 0; i < positions.length; i += 3) {\n      scratchOffset.copy(attributes.positions.value.subarray(i, i + 3));\n      positions.set(scratchOffset, i);\n    }\n\n    const geometry = new Geometry({\n      drawMode: GL.TRIANGLES,\n      attributes: {\n        positions,\n        normals,\n        texCoords\n      }\n    });\n\n    const SubLayerClass = this.getSubLayerClass('mesh', SimpleMeshLayer);\n\n    return new SubLayerClass(\n      this.getSubLayerProps({\n        id: 'mesh'\n      }),\n      {\n        id: `${this.id}-mesh-${tileHeader.id}`,\n        mesh: geometry,\n        data: [{}],\n        getPosition: [0, 0, 0],\n        getColor: [255, 255, 255],\n        texture,\n        modelMatrix,\n        coordinateOrigin: cartographicOrigin,\n        coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS\n      }\n    );\n  }\n\n  renderLayers() {\n    const {tileset3d, layerMap} = this.state;\n    if (!tileset3d) {\n      return null;\n    }\n\n    return tileset3d.tiles\n      .map(tile => {\n        let layer = layerMap[tile.id] && layerMap[tile.id].layer;\n        // render selected tiles\n        if (tile.selected) {\n          // create layer\n          if (!layer) {\n            layer = this._create3DTileLayer(tile);\n            layerMap[tile.id] = {layer, tile};\n          }\n          // update layer visibility\n          if (layer && layer.props && !layer.props.visible) {\n            // Still has GPU resource but visibility is turned off so turn it back on so we can render it.\n            layer = layer.clone({visible: true});\n            layerMap[tile.id].layer = layer;\n          }\n          return layer;\n        }\n\n        // hide non-selected tiles\n        if (layer && layer.props && layer.props.visible) {\n          // Still in tileset cache but doesn't need to render this frame. Keep the GPU resource bound but don't render it.\n          layer = layer.clone({visible: false});\n          layerMap[tile.id].layer = layer;\n        }\n        return layer;\n      })\n      .filter(Boolean);\n  }\n}\n\nTile3DLayer.layerName = 'Tile3DLayer';\nTile3DLayer.defaultProps = defaultProps;\n"],"file":"tile-3d-layer.js"}