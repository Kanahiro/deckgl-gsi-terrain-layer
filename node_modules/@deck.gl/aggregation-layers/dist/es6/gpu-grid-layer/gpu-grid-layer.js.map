{"version":3,"sources":["../../../src/gpu-grid-layer/gpu-grid-layer.js"],"names":["Buffer","log","GPUGridAggregator","AGGREGATION_OPERATION","defaultColorRange","colorRangeToFlatArray","GPUGridCellLayer","pointToDensityGridDataCPU","GridAggregationLayer","getBoundingBox","getGridParams","defaultProps","colorDomain","colorRange","getColorWeight","type","value","x","colorAggregation","elevationDomain","elevationRange","getElevationWeight","elevationAggregation","elevationScale","min","cellSize","max","coverage","getPosition","position","extruded","material","DIMENSIONS","data","props","POSITION_ATTRIBUTE_NAME","GPUGridLayer","initializeState","gl","context","isSupported","error","dimensions","setState","gpuAggregation","projectPoints","weights","color","needMin","needMax","combineMaxMin","maxMinBuffer","byteLength","accessor","size","divisor","elevation","positionAttributeName","attributeManager","getAttributeManager","add","fp64","use64bitPositions","updateState","opts","state","aggregationDirty","gridHash","getHashKeyForIndex","index","numRow","numCol","boundingBox","gridOffset","gridSize","gridOrigin","xMin","yMin","xOffset","yOffset","yIndex","Math","floor","xIndex","latIdx","lonIdx","getPositionForIndex","yPos","xPos","getPickingInfo","info","mode","object","gpuGridAggregator","colorInfo","getAggregationData","Object","assign","pixelIndex","getData","elevationInfo","colorValue","cellWeight","elevationValue","count","cellCount","totalCount","translation","viewport","attributes","getAttributes","cpuAggregation","key","cpuAggregationData","picked","Boolean","renderLayers","cellSizeMeters","SubLayerClass","getSubLayerClass","getSubLayerProps","id","colors","aggregationBuffer","elevations","colorMaxMinBuffer","elevationMaxMinBuffer","numInstances","finalizeState","forEach","weight","delete","updateAggregationState","oldProps","coordinateSystem","cellSizeChanged","positionsChanged","isAttributeChanged","attributesChanged","getNumInstances","width","height","allocateResources","aggregationDataDirty","isAggregationDirty","dimension","compareAll","_updateAccessors","operation","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Buffer} from '@luma.gl/core';\nimport GL from '@luma.gl/constants';\nimport {log} from '@deck.gl/core';\n\nimport GPUGridAggregator from '../utils/gpu-grid-aggregation/gpu-grid-aggregator';\nimport {AGGREGATION_OPERATION} from '../utils/aggregation-operation-utils';\nimport {defaultColorRange, colorRangeToFlatArray} from '../utils/color-utils';\nimport GPUGridCellLayer from './gpu-grid-cell-layer';\nimport {pointToDensityGridDataCPU} from './../cpu-grid-layer/grid-aggregator';\nimport GridAggregationLayer from '../grid-aggregation-layer';\nimport {getBoundingBox, getGridParams} from '../utils/grid-aggregation-utils';\n\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n  getColorWeight: {type: 'accessor', value: x => 1},\n  colorAggregation: 'SUM',\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  getElevationWeight: {type: 'accessor', value: x => 1},\n  elevationAggregation: 'SUM',\n  elevationScale: {type: 'number', min: 0, value: 1},\n\n  // grid\n  cellSize: {type: 'number', min: 1, max: 1000, value: 1000},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  getPosition: {type: 'accessor', value: x => x.position},\n  extruded: false,\n\n  // Optional material for 'lighting' shader module\n  material: true\n};\n\n// This layer only perform GPU aggregation, no need to seperate data and weight props\n// aggregation will be dirty when any of the props are changed.\n\nconst DIMENSIONS = {\n  data: {\n    props: ['cellSize', 'colorAggregation', 'elevationAggregation']\n  }\n  // rest of the changes are detected by `state.attributesChanged`\n};\nconst POSITION_ATTRIBUTE_NAME = 'positions';\n\nexport default class GPUGridLayer extends GridAggregationLayer {\n  initializeState() {\n    const {gl} = this.context;\n    const isSupported = GPUGridAggregator.isSupported(gl);\n    if (!isSupported) {\n      log.error('GPUGridLayer is not supported on this browser, use GridLayer instead')();\n    }\n    super.initializeState({\n      dimensions: DIMENSIONS\n    });\n    this.setState({\n      gpuAggregation: true,\n      projectPoints: false, // aggregation in world space\n      isSupported,\n      weights: {\n        color: {\n          needMin: true,\n          needMax: true,\n          combineMaxMin: true,\n          maxMinBuffer: new Buffer(gl, {\n            byteLength: 4 * 4,\n            accessor: {size: 4, type: GL.FLOAT, divisor: 1}\n          })\n        },\n        elevation: {\n          needMin: true,\n          needMax: true,\n          combineMaxMin: true,\n          maxMinBuffer: new Buffer(gl, {\n            byteLength: 4 * 4,\n            accessor: {size: 4, type: GL.FLOAT, divisor: 1}\n          })\n        }\n      },\n      positionAttributeName: 'positions'\n    });\n    const attributeManager = this.getAttributeManager();\n    attributeManager.add({\n      [POSITION_ATTRIBUTE_NAME]: {\n        size: 3,\n        accessor: 'getPosition',\n        type: GL.DOUBLE,\n        fp64: this.use64bitPositions()\n      },\n      color: {size: 3, accessor: 'getColorWeight'},\n      elevation: {size: 3, accessor: 'getElevationWeight'}\n    });\n  }\n\n  updateState(opts) {\n    if (this.state.isSupported === false) {\n      // Skip update, layer not supported\n      return;\n    }\n    super.updateState(opts);\n    const {aggregationDirty} = this.state;\n    if (aggregationDirty) {\n      // reset cached CPU Aggregation results (used for picking)\n      this.setState({\n        gridHash: null\n      });\n    }\n  }\n\n  getHashKeyForIndex(index) {\n    const {numRow, numCol, boundingBox, gridOffset} = this.state;\n    const gridSize = [numCol, numRow];\n    const gridOrigin = [boundingBox.xMin, boundingBox.yMin];\n    const cellSize = [gridOffset.xOffset, gridOffset.yOffset];\n\n    const yIndex = Math.floor(index / gridSize[0]);\n    const xIndex = index - yIndex * gridSize[0];\n    // This will match the index to the hash-key to access aggregation data from CPU aggregation results.\n    const latIdx = Math.floor(\n      (yIndex * cellSize[1] + gridOrigin[1] + 90 + cellSize[1] / 2) / cellSize[1]\n    );\n    const lonIdx = Math.floor(\n      (xIndex * cellSize[0] + gridOrigin[0] + 180 + cellSize[0] / 2) / cellSize[0]\n    );\n    return `${latIdx}-${lonIdx}`;\n  }\n\n  getPositionForIndex(index) {\n    const {numRow, numCol, boundingBox, gridOffset} = this.state;\n    const gridSize = [numCol, numRow];\n    const gridOrigin = [boundingBox.xMin, boundingBox.yMin];\n    const cellSize = [gridOffset.xOffset, gridOffset.yOffset];\n\n    const yIndex = Math.floor(index / gridSize[0]);\n    const xIndex = index - yIndex * gridSize[0];\n    const yPos = yIndex * cellSize[1] + gridOrigin[1];\n    const xPos = xIndex * cellSize[0] + gridOrigin[0];\n    return [xPos, yPos];\n  }\n\n  getPickingInfo({info, mode}) {\n    const {index} = info;\n    let object = null;\n    if (index >= 0) {\n      const {gpuGridAggregator} = this.state;\n      const position = this.getPositionForIndex(index);\n      const colorInfo = GPUGridAggregator.getAggregationData(\n        Object.assign({pixelIndex: index}, gpuGridAggregator.getData('color'))\n      );\n      const elevationInfo = GPUGridAggregator.getAggregationData(\n        Object.assign({pixelIndex: index}, gpuGridAggregator.getData('elevation'))\n      );\n\n      object = {\n        colorValue: colorInfo.cellWeight,\n        elevationValue: elevationInfo.cellWeight,\n        count: colorInfo.cellCount || elevationInfo.cellCount,\n        position,\n        totalCount: colorInfo.totalCount || elevationInfo.totalCount\n      };\n      if (mode !== 'hover') {\n        // perform CPU aggregation for full list of points for each cell\n        const {props} = this;\n        let {gridHash} = this.state;\n        if (!gridHash) {\n          const {gridOffset, translation, boundingBox} = this.state;\n          const {viewport} = this.context;\n          const attributes = this.getAttributes();\n          const cpuAggregation = pointToDensityGridDataCPU(props, {\n            gridOffset,\n            attributes,\n            viewport,\n            translation,\n            boundingBox\n          });\n          gridHash = cpuAggregation.gridHash;\n          this.setState({gridHash});\n        }\n        const key = this.getHashKeyForIndex(index);\n        const cpuAggregationData = gridHash[key];\n        Object.assign(object, cpuAggregationData);\n      }\n    }\n\n    return Object.assign(info, {\n      picked: Boolean(object),\n      // override object with picked cell\n      object\n    });\n  }\n\n  renderLayers() {\n    if (!this.state.isSupported) {\n      return null;\n    }\n    const {\n      elevationScale,\n      extruded,\n      cellSize: cellSizeMeters,\n      coverage,\n      material,\n      elevationRange,\n      colorDomain,\n      elevationDomain\n    } = this.props;\n\n    const {weights, numRow, numCol, gridOrigin, gridOffset} = this.state;\n    const {color, elevation} = weights;\n    const colorRange = colorRangeToFlatArray(this.props.colorRange);\n\n    const SubLayerClass = this.getSubLayerClass('gpu-grid-cell', GPUGridCellLayer);\n\n    return new SubLayerClass(\n      {\n        gridSize: [numCol, numRow],\n        gridOrigin,\n        gridOffset: [gridOffset.xOffset, gridOffset.yOffset],\n        colorRange,\n        elevationRange,\n        colorDomain,\n        elevationDomain,\n\n        cellSize: cellSizeMeters,\n        coverage,\n        material,\n        elevationScale,\n        extruded\n      },\n      this.getSubLayerProps({\n        id: 'gpu-grid-cell'\n      }),\n      {\n        data: {\n          attributes: {\n            colors: color.aggregationBuffer,\n            elevations: elevation.aggregationBuffer\n          }\n        },\n        colorMaxMinBuffer: color.maxMinBuffer,\n        elevationMaxMinBuffer: elevation.maxMinBuffer,\n        numInstances: numCol * numRow\n      }\n    );\n  }\n\n  finalizeState() {\n    const {color, elevation} = this.state.weights;\n    [color, elevation].forEach(weight => {\n      const {aggregationBuffer, maxMinBuffer} = weight;\n      maxMinBuffer.delete();\n      if (aggregationBuffer) {\n        aggregationBuffer.delete();\n      }\n    });\n    super.finalizeState();\n  }\n\n  // Aggregation Overrides\n\n  updateAggregationState(opts) {\n    const {props, oldProps} = opts;\n    const {cellSize, coordinateSystem} = props;\n    const {viewport} = this.context;\n    const cellSizeChanged = oldProps.cellSize !== cellSize;\n    const {dimensions} = this.state;\n\n    const positionsChanged = this.isAttributeChanged(POSITION_ATTRIBUTE_NAME);\n    // any attribute changed\n    const attributesChanged = positionsChanged || this.isAttributeChanged();\n\n    let {boundingBox} = this.state;\n    if (positionsChanged) {\n      boundingBox = getBoundingBox(this.getAttributes(), this.getNumInstances());\n      this.setState({boundingBox});\n    }\n    if (positionsChanged || cellSizeChanged) {\n      const {gridOffset, translation, width, height, numCol, numRow} = getGridParams(\n        boundingBox,\n        cellSize,\n        viewport,\n        coordinateSystem\n      );\n      this.allocateResources(numRow, numCol);\n      this.setState({\n        gridOffset,\n        translation,\n        gridOrigin: [-1 * translation[0], -1 * translation[1]],\n        width,\n        height,\n        numCol,\n        numRow\n      });\n    }\n\n    const aggregationDataDirty =\n      attributesChanged ||\n      this.isAggregationDirty(opts, {\n        dimension: dimensions.data,\n        compareAll: true\n      });\n\n    if (aggregationDataDirty) {\n      this._updateAccessors(opts);\n    }\n    this.setState({\n      aggregationDataDirty\n    });\n  }\n\n  // Private\n\n  _updateAccessors(opts) {\n    const {colorAggregation, elevationAggregation} = opts.props;\n    const {color, elevation} = this.state.weights;\n    color.operation = AGGREGATION_OPERATION[colorAggregation];\n    elevation.operation = AGGREGATION_OPERATION[elevationAggregation];\n  }\n}\n\nGPUGridLayer.layerName = 'GPUGridLayer';\nGPUGridLayer.defaultProps = defaultProps;\n"],"file":"gpu-grid-layer.js"}