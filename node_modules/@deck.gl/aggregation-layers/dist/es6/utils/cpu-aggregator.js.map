{"version":3,"sources":["../../../src/utils/cpu-aggregator.js"],"names":["BinSorter","getScaleFunctionByScaleType","getValueFunc","nop","dimensionSteps","defaultDimensions","key","accessor","pickingInfo","getBins","triggers","value","prop","updateTrigger","weight","aggregation","filterData","getDomain","lowerPercentile","upperPercentile","scaleType","getScaleFunc","domain","range","onSet","props","nullValue","defaultGetCellSize","cellSize","CPUAggregator","constructor","opts","state","layerData","dimensions","changeFlags","dimensionUpdaters","_getCellSize","getCellSize","_getAggregator","getAggregator","_addDimension","updateState","aggregationParams","oldProps","updateGetValueFuncs","reprojectNeeded","needsReProjectPoints","aggregationDirty","dataChanged","getAggregatedData","dimensionChanges","getDimensionChanges","forEach","f","setState","updateObject","Object","assign","setDimensionState","normalizeResult","result","hexagons","data","aggregator","getSortedBins","getValue","getValueChanged","needUpdateDimensionStep","updateTriggersChanged","all","getPosition","addDimension","dimension","getDimensionUpdaters","sortedBins","scaleFunc","updater","getDimensionSortedBins","getDimensionValueDomain","getDimensionScale","attributeAccessor","getSubLayerDimensionAttribute","dimensionStep","values","some","item","updaters","needUpdate","find","step","push","bind","length","getUpdateTriggers","_updateTriggers","updateTriggers","fromProp","Array","isArray","undefined","dimensionUpdater","_filterData","valueDomain","getValueDomainByScale","dimensionRange","dimensionDomain","getScaleFunction","cell","bin","binMap","index","counts","cv","isValueInDomain","getSubLayerAccessors","accessors","getPickingInfo","info","isPicked","picked","object","binInfo","points","filteredPoints","Boolean","getAccessor","dimensionKey","hasOwnProperty"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2018 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport BinSorter from './bin-sorter';\nimport {getScaleFunctionByScaleType} from './scale-utils';\nimport {getValueFunc} from './aggregation-operation-utils';\n\nfunction nop() {}\n\nconst dimensionSteps = ['getBins', 'getDomain', 'getScaleFunc'];\nconst defaultDimensions = [\n  {\n    key: 'fillColor',\n    accessor: 'getFillColor',\n    pickingInfo: 'colorValue',\n    getBins: {\n      triggers: {\n        value: {\n          prop: 'getColorValue',\n          updateTrigger: 'getColorValue'\n        },\n        weight: {\n          prop: 'getColorWeight',\n          updateTrigger: 'getColorWeight'\n        },\n        aggregation: {\n          prop: 'colorAggregation'\n        },\n        filterData: {\n          prop: '_filterData',\n          updateTrigger: '_filterData'\n        }\n      }\n    },\n    getDomain: {\n      triggers: {\n        lowerPercentile: {\n          prop: 'lowerPercentile'\n        },\n        upperPercentile: {\n          prop: 'upperPercentile'\n        },\n        scaleType: {\n          prop: 'colorScaleType'\n        }\n      }\n    },\n    getScaleFunc: {\n      triggers: {\n        domain: {prop: 'colorDomain'},\n        range: {prop: 'colorRange'}\n      },\n      onSet: {\n        props: 'onSetColorDomain'\n      }\n    },\n    nullValue: [0, 0, 0, 0]\n  },\n  {\n    key: 'elevation',\n    accessor: 'getElevation',\n    pickingInfo: 'elevationValue',\n    getBins: {\n      triggers: {\n        value: {\n          prop: 'getElevationValue',\n          updateTrigger: 'getElevationValue'\n        },\n        weight: {\n          prop: 'getElevationWeight',\n          updateTrigger: 'getElevationWeight'\n        },\n        aggregation: {\n          prop: 'elevationAggregation'\n        },\n        filterData: {\n          prop: '_filterData',\n          updateTrigger: '_filterData'\n        }\n      }\n    },\n    getDomain: {\n      triggers: {\n        lowerPercentile: {\n          prop: 'elevationLowerPercentile'\n        },\n        upperPercentile: {\n          prop: 'elevationUpperPercentile'\n        },\n        scaleType: {\n          prop: 'elevationScaleType'\n        }\n      }\n    },\n    getScaleFunc: {\n      triggers: {\n        domain: {prop: 'elevationDomain'},\n        range: {prop: 'elevationRange'}\n      },\n      onSet: {\n        props: 'onSetElevationDomain'\n      }\n    },\n    nullValue: -1\n  }\n];\nconst defaultGetCellSize = props => props.cellSize;\nexport default class CPUAggregator {\n  constructor(opts) {\n    this.state = {\n      layerData: {},\n      dimensions: {\n        // color: {\n        //   getValue: null,\n        //   domain: null,\n        //   sortedBins: null,\n        //   scaleFunc: nop\n        // },\n        // elevation: {\n        //   getValue: null,\n        //   domain: null,\n        //   sortedBins: null,\n        //   scaleFunc: nop\n        // }\n      }\n    };\n    this.changeFlags = {};\n    this.dimensionUpdaters = {};\n\n    this._getCellSize = opts.getCellSize || defaultGetCellSize;\n    this._getAggregator = opts.getAggregator;\n    this._addDimension(opts.dimensions || defaultDimensions);\n  }\n\n  static defaultDimensions() {\n    return defaultDimensions;\n  }\n\n  updateState(opts, aggregationParams) {\n    const {oldProps, props, changeFlags} = opts;\n    this.updateGetValueFuncs(oldProps, props, changeFlags);\n    const reprojectNeeded = this.needsReProjectPoints(oldProps, props, changeFlags);\n    let aggregationDirty = false;\n    if (changeFlags.dataChanged || reprojectNeeded) {\n      // project data into bin and aggregate wegiths per bin\n      this.getAggregatedData(props, aggregationParams);\n      aggregationDirty = true;\n    } else {\n      const dimensionChanges = this.getDimensionChanges(oldProps, props, changeFlags) || [];\n      // this here is layer\n      dimensionChanges.forEach(f => typeof f === 'function' && f());\n      aggregationDirty = true;\n    }\n    this.setState({aggregationDirty});\n\n    return this.state;\n  }\n\n  // Update private state\n  setState(updateObject) {\n    this.state = Object.assign({}, this.state, updateObject);\n  }\n\n  // Update private state.dimensions\n  setDimensionState(key, updateObject) {\n    this.setState({\n      dimensions: Object.assign({}, this.state.dimensions, {\n        [key]: Object.assign({}, this.state.dimensions[key], updateObject)\n      })\n    });\n  }\n\n  normalizeResult(result = {}) {\n    // support previous hexagonAggregator API\n    if (result.hexagons) {\n      return Object.assign({data: result.hexagons}, result);\n    } else if (result.layerData) {\n      return Object.assign({data: result.layerData}, result);\n    }\n\n    return result;\n  }\n\n  getAggregatedData(props, aggregationParams) {\n    const aggregator = this._getAggregator(props);\n\n    const result = aggregator(props, aggregationParams);\n    this.setState({\n      layerData: this.normalizeResult(result)\n    });\n    this.changeFlags = {\n      layerData: true\n    };\n    this.getSortedBins(props);\n  }\n\n  updateGetValueFuncs(oldProps, props, changeFlags) {\n    for (const key in this.dimensionUpdaters) {\n      const {value, weight, aggregation} = this.dimensionUpdaters[key].getBins.triggers;\n      let getValue = props[value.prop];\n      const getValueChanged = this.needUpdateDimensionStep(\n        this.dimensionUpdaters[key].getBins,\n        oldProps,\n        props,\n        changeFlags\n      );\n\n      if (getValueChanged && getValue === null) {\n        // If `getValue` is not provided from props, build it with aggregation and weight.\n        getValue = getValueFunc(props[aggregation.prop], props[weight.prop]);\n      }\n\n      if (getValue) {\n        this.setDimensionState(key, {getValue});\n      }\n    }\n  }\n\n  needsReProjectPoints(oldProps, props, changeFlags) {\n    return (\n      this._getCellSize(oldProps) !== this._getCellSize(props) ||\n      this._getAggregator(oldProps) !== this._getAggregator(props) ||\n      (changeFlags.updateTriggersChanged &&\n        (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getPosition))\n    );\n  }\n\n  // Adds dimensions\n  addDimension(dimensions) {\n    this._addDimension(dimensions);\n  }\n\n  _addDimension(dimensions = []) {\n    dimensions.forEach(dimension => {\n      const {key} = dimension;\n      this.dimensionUpdaters[key] = this.getDimensionUpdaters(dimension);\n      this.state.dimensions[key] = {\n        getValue: null,\n        domain: null,\n        sortedBins: null,\n        scaleFunc: nop\n      };\n    });\n  }\n\n  getDimensionUpdaters({key, accessor, pickingInfo, getBins, getDomain, getScaleFunc, nullValue}) {\n    return {\n      key,\n      accessor,\n      pickingInfo,\n      getBins: Object.assign({updater: this.getDimensionSortedBins}, getBins),\n      getDomain: Object.assign({updater: this.getDimensionValueDomain}, getDomain),\n      getScaleFunc: Object.assign({updater: this.getDimensionScale}, getScaleFunc),\n      attributeAccessor: this.getSubLayerDimensionAttribute(key, nullValue)\n    };\n  }\n\n  needUpdateDimensionStep(dimensionStep, oldProps, props, changeFlags) {\n    // whether need to update current dimension step\n    // dimension step is the value, domain, scaleFunction of each dimension\n    // each step is an object with properties links to layer prop and whether the prop is\n    // controlled by updateTriggers\n    // getBins: {\n    //   value: {\n    //     prop: 'getElevationValue',\n    //     updateTrigger: 'getElevationValue'\n    //   },\n    //   weight: {\n    //     prop: 'getElevationWeight',\n    //     updateTrigger: 'getElevationWeight'\n    //   },\n    //   aggregation: {\n    //     prop: 'elevationAggregation'\n    //   }\n    // }\n    return Object.values(dimensionStep.triggers).some(item => {\n      if (item.updateTrigger) {\n        // check based on updateTriggers change first\n        return (\n          changeFlags.updateTriggersChanged &&\n          (changeFlags.updateTriggersChanged.all ||\n            changeFlags.updateTriggersChanged[item.updateTrigger])\n        );\n      }\n      // fallback to direct comparison\n      return oldProps[item.prop] !== props[item.prop];\n    });\n  }\n\n  getDimensionChanges(oldProps, props, changeFlags) {\n    // const {dimensionUpdaters} = this.state;\n    const updaters = [];\n\n    // get dimension to be updated\n    for (const key in this.dimensionUpdaters) {\n      // return the first triggered updater for each dimension\n      const needUpdate = dimensionSteps.find(step =>\n        this.needUpdateDimensionStep(\n          this.dimensionUpdaters[key][step],\n          oldProps,\n          props,\n          changeFlags\n        )\n      );\n\n      if (needUpdate) {\n        updaters.push(\n          this.dimensionUpdaters[key][needUpdate].updater.bind(\n            this,\n            props,\n            this.dimensionUpdaters[key]\n          )\n        );\n      }\n    }\n\n    return updaters.length ? updaters : null;\n  }\n\n  getUpdateTriggers(props) {\n    const _updateTriggers = props.updateTriggers || {};\n    const updateTriggers = {};\n\n    for (const key in this.dimensionUpdaters) {\n      const {accessor} = this.dimensionUpdaters[key];\n      // fold dimension triggers into each accessor\n      updateTriggers[accessor] = {};\n\n      dimensionSteps.forEach(step => {\n        Object.values(this.dimensionUpdaters[key][step].triggers).forEach(\n          ({prop, updateTrigger}) => {\n            if (updateTrigger) {\n              // if prop is based on updateTrigger e.g. getColorValue, getColorWeight\n              // and updateTriggers is passed in from layer prop\n              // fold the updateTriggers into accessor\n              const fromProp = _updateTriggers[updateTrigger];\n              if (typeof fromProp === 'object' && !Array.isArray(fromProp)) {\n                // if updateTrigger is an object spread it\n                Object.assign(updateTriggers[accessor], fromProp);\n              } else if (fromProp !== undefined) {\n                updateTriggers[accessor][prop] = fromProp;\n              }\n            } else {\n              // if prop is not based on updateTrigger\n              updateTriggers[accessor][prop] = props[prop];\n            }\n          }\n        );\n      });\n    }\n\n    return updateTriggers;\n  }\n\n  getSortedBins(props) {\n    for (const key in this.dimensionUpdaters) {\n      this.getDimensionSortedBins(props, this.dimensionUpdaters[key]);\n    }\n  }\n\n  getDimensionSortedBins(props, dimensionUpdater) {\n    const {key} = dimensionUpdater;\n    const {getValue} = this.state.dimensions[key];\n\n    const sortedBins = new BinSorter(this.state.layerData.data || [], {\n      getValue,\n      filterData: props._filterData\n    });\n    this.setDimensionState(key, {sortedBins});\n    this.getDimensionValueDomain(props, dimensionUpdater);\n  }\n\n  getDimensionValueDomain(props, dimensionUpdater) {\n    const {getDomain, key} = dimensionUpdater;\n    const {\n      triggers: {lowerPercentile, upperPercentile, scaleType}\n    } = getDomain;\n    const valueDomain = this.state.dimensions[key].sortedBins.getValueDomainByScale(\n      props[scaleType.prop],\n      [props[lowerPercentile.prop], props[upperPercentile.prop]]\n    );\n\n    this.setDimensionState(key, {valueDomain});\n    this.getDimensionScale(props, dimensionUpdater);\n  }\n\n  getDimensionScale(props, dimensionUpdater) {\n    const {key, getScaleFunc, getDomain} = dimensionUpdater;\n    const {domain, range} = getScaleFunc.triggers;\n    const {scaleType} = getDomain.triggers;\n    const {onSet} = getScaleFunc;\n    const dimensionRange = props[range.prop];\n    const dimensionDomain = props[domain.prop] || this.state.dimensions[key].valueDomain;\n    const getScaleFunction = getScaleFunctionByScaleType(scaleType && props[scaleType.prop]);\n    const scaleFunc = getScaleFunction(dimensionDomain, dimensionRange);\n\n    if (typeof onSet === 'object' && typeof props[onSet.props] === 'function') {\n      props[onSet.props](scaleFunc.domain());\n    }\n\n    this.setDimensionState(key, {scaleFunc});\n  }\n\n  getSubLayerDimensionAttribute(key, nullValue) {\n    return cell => {\n      const {sortedBins, scaleFunc} = this.state.dimensions[key];\n      const bin = sortedBins.binMap[cell.index];\n\n      if (bin && bin.counts === 0) {\n        // no points left in bin after filtering\n        return nullValue;\n      }\n      const cv = bin && bin.value;\n      const domain = scaleFunc.domain();\n\n      const isValueInDomain = cv >= domain[0] && cv <= domain[domain.length - 1];\n\n      // if cell value is outside domain, set alpha to 0\n      return isValueInDomain ? scaleFunc(cv) : nullValue;\n    };\n  }\n\n  getSubLayerAccessors(props) {\n    const accessors = {};\n    for (const key in this.dimensionUpdaters) {\n      const {accessor} = this.dimensionUpdaters[key];\n      accessors[accessor] = this.getSubLayerDimensionAttribute(props, key);\n    }\n\n    return accessors;\n  }\n\n  getPickingInfo({info}) {\n    const isPicked = info.picked && info.index > -1;\n    let object = null;\n\n    if (isPicked) {\n      // const {sortedColorBins, sortedElevationBins} = this.state;\n\n      const cell = this.state.layerData.data[info.index];\n\n      const binInfo = {};\n      for (const key in this.dimensionUpdaters) {\n        const {pickingInfo} = this.dimensionUpdaters[key];\n        const {sortedBins} = this.state.dimensions[key];\n        const value = sortedBins.binMap[cell.index] && sortedBins.binMap[cell.index].value;\n        binInfo[pickingInfo] = value;\n      }\n\n      object = Object.assign(binInfo, cell, {\n        points: cell.filteredPoints || cell.points\n      });\n    }\n\n    // add bin colorValue and elevationValue to info\n    return Object.assign(info, {\n      picked: Boolean(object),\n      // override object with picked cell\n      object\n    });\n  }\n\n  getAccessor(dimensionKey) {\n    if (!this.dimensionUpdaters.hasOwnProperty(dimensionKey)) {\n      return nop;\n    }\n    return this.dimensionUpdaters[dimensionKey].attributeAccessor;\n  }\n}\n"],"file":"cpu-aggregator.js"}