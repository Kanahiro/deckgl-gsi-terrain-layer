{"version":3,"sources":["../../../src/utils/bin-sorter.js"],"names":["defaultGetValue","points","length","clamp","getQuantileDomain","getOrdinalDomain","MAX_32_BIT_FLOAT","defaultGetPoints","bin","defaultGetIndex","index","ascending","a","b","NaN","defaultProps","getValue","getPoints","getIndex","filterData","BinSorter","bins","props","aggregatedBins","getAggregatedBins","_updateMinMaxValues","binMap","getBinMap","hasFilter","binCount","binIndex","i","filteredPoints","filter","value","undefined","Number","isFinite","counts","percentileRange","len","sortedBins","map","n","lower","upper","lowerIdx","Math","ceil","upperIdx","floor","maxCount","maxValue","minValue","totalCount","x","sort","Array","isArray","idxRange","_percentileToIndex","scale","indexEdge","_getScaleDomain","scaleType","slice","d"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n// getValue takes an array of points returns a value to sort the bins on.\n// by default it returns the number of points\n// this is where to pass in a function to color the bins by\n// avg/mean/max of specific value of the point\nconst defaultGetValue = points => points.length;\n\nimport {clamp, getQuantileDomain, getOrdinalDomain} from './scale-utils';\n\nconst MAX_32_BIT_FLOAT = 3.402823466e38;\n\n// access array of points in each bin\nconst defaultGetPoints = bin => bin.points;\n// access index of each bin\nconst defaultGetIndex = bin => bin.index;\n\n// d3-scending\nconst ascending = (a, b) => (a < b ? -1 : a > b ? 1 : a >= b ? 0 : NaN);\n\nconst defaultProps = {\n  getValue: defaultGetValue,\n  getPoints: defaultGetPoints,\n  getIndex: defaultGetIndex,\n  filterData: null\n};\n\nexport default class BinSorter {\n  constructor(bins = [], props = defaultProps) {\n    this.aggregatedBins = this.getAggregatedBins(bins, props);\n    this._updateMinMaxValues();\n    this.binMap = this.getBinMap();\n  }\n\n  /**\n   * Get an array of object with aggregated values and index of bins\n   * Array object will be sorted by value optionally.\n   * @param {Array} bins\n   * @param {Function} getValue\n   * @return {Array} array of values and index lookup\n   */\n  getAggregatedBins(bins, props) {\n    const {\n      getValue = defaultGetValue,\n      getPoints = defaultGetPoints,\n      getIndex = defaultGetIndex,\n      filterData\n    } = props;\n\n    const hasFilter = typeof filterData === 'function';\n    const binCount = bins.length;\n    const aggregatedBins = [];\n    let index = 0;\n\n    for (let binIndex = 0; binIndex < binCount; binIndex++) {\n      const bin = bins[binIndex];\n      const points = getPoints(bin);\n      const i = getIndex(bin);\n\n      const filteredPoints = hasFilter ? points.filter(filterData) : points;\n\n      bin.filteredPoints = hasFilter ? filteredPoints : null;\n\n      const value = filteredPoints.length ? getValue(filteredPoints) : null;\n\n      if (value !== null && value !== undefined) {\n        // filter bins if value is null or undefined\n        aggregatedBins[index] = {\n          i: Number.isFinite(i) ? i : binIndex,\n          value,\n          counts: filteredPoints.length\n        };\n        index++;\n      }\n    }\n    return aggregatedBins;\n  }\n\n  _percentileToIndex(percentileRange) {\n    const len = this.sortedBins.length;\n    if (len < 2) {\n      return [0, 0];\n    }\n\n    const [lower, upper] = percentileRange.map(n => clamp(n, 0, 100));\n\n    const lowerIdx = Math.ceil((lower / 100) * (len - 1));\n    const upperIdx = Math.floor((upper / 100) * (len - 1));\n\n    return [lowerIdx, upperIdx];\n  }\n\n  /**\n   * Get a mapping from cell/hexagon index to sorted bin\n   * This is used to retrieve bin value for color calculation\n   * @return {Object} bin index to aggregatedBins\n   */\n  getBinMap() {\n    const binMap = {};\n    for (const bin of this.aggregatedBins) {\n      binMap[bin.i] = bin;\n    }\n    return binMap;\n  }\n\n  // Private\n\n  /**\n   * Get ths max count of all bins\n   * @return {Number | Boolean} max count\n   */\n  _updateMinMaxValues() {\n    let maxCount = 0;\n    let maxValue = 0;\n    let minValue = MAX_32_BIT_FLOAT;\n    let totalCount = 0;\n    for (const x of this.aggregatedBins) {\n      maxCount = maxCount > x.counts ? maxCount : x.counts;\n      maxValue = maxValue > x.value ? maxValue : x.value;\n      minValue = minValue < x.value ? minValue : x.value;\n      totalCount += x.counts;\n    }\n    this.maxCount = maxCount;\n    this.maxValue = maxValue;\n    this.minValue = minValue;\n    this.totalCount = totalCount;\n  }\n\n  /**\n   * Get range of values of all bins\n   * @param {Number[]} range\n   * @param {Number} range[0] - lower bound\n   * @param {Number} range[1] - upper bound\n   * @return {Array} array of new value range\n   */\n  getValueRange(percentileRange) {\n    if (!this.sortedBins) {\n      this.sortedBins = this.aggregatedBins.sort((a, b) => ascending(a.value, b.value));\n    }\n    if (!this.sortedBins.length) {\n      return [];\n    }\n    let lowerIdx = 0;\n    let upperIdx = this.sortedBins.length - 1;\n\n    if (Array.isArray(percentileRange)) {\n      const idxRange = this._percentileToIndex(percentileRange);\n      lowerIdx = idxRange[0];\n      upperIdx = idxRange[1];\n    }\n\n    return [this.sortedBins[lowerIdx].value, this.sortedBins[upperIdx].value];\n  }\n\n  getValueDomainByScale(scale, [lower = 0, upper = 100] = []) {\n    if (!this.sortedBins) {\n      this.sortedBins = this.aggregatedBins.sort((a, b) => ascending(a.value, b.value));\n    }\n    if (!this.sortedBins.length) {\n      return [];\n    }\n    const indexEdge = this._percentileToIndex([lower, upper]);\n\n    return this._getScaleDomain(scale, indexEdge);\n  }\n\n  _getScaleDomain(scaleType, [lowerIdx, upperIdx]) {\n    const bins = this.sortedBins;\n\n    switch (scaleType) {\n      case 'quantize':\n      case 'linear':\n        return [bins[lowerIdx].value, bins[upperIdx].value];\n\n      case 'quantile':\n        return getQuantileDomain(bins.slice(lowerIdx, upperIdx + 1), d => d.value);\n\n      case 'ordinal':\n        return getOrdinalDomain(bins, d => d.value);\n\n      default:\n        return [bins[lowerIdx].value, bins[upperIdx].value];\n    }\n  }\n}\n"],"file":"bin-sorter.js"}