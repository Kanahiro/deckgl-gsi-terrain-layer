{"version":3,"sources":["../../../src/api/maps-api-client.js"],"names":["DEFAULT_USER_COMPONENT_IN_URL","REQUEST_GET_MAX_URL_LENGTH","getMapTileJSON","props","data","bufferSize","version","tileExtent","credentials","creds","mapConfig","createMapConfig","instantiateMap","layergroup","tiles","metadata","tilejson","vector","isSQL","search","sql","buffersize","mvt","layers","type","options","trim","vector_extent","config","JSON","stringify","request","createMapsApiRequest","fetch","response","Error","json","ok","dealWithWindshaftError","status","username","apiKey","errors","encodedApiKey","encodeParameter","encodedClient","parameters","url","generateMapsApiUrl","getUrl","length","getRequest","postRequest","base","serverURL","join","serverUrlTemplate","replace","endsWith","Request","method","headers","Accept","payload","body","name","value","encodeURIComponent"],"mappings":"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","sourcesContent":["import {getDefaultCredentials} from '../auth';\n\nconst DEFAULT_USER_COMPONENT_IN_URL = '{user}';\nconst REQUEST_GET_MAX_URL_LENGTH = 2048;\n\n/**\n * Obtain a TileJson from Maps API v1\n */\nexport async function getMapTileJSON(props) {\n  const {data, bufferSize, version, tileExtent, credentials} = props;\n  const creds = {...getDefaultCredentials(), ...credentials};\n\n  const mapConfig = createMapConfig({data, bufferSize, version, tileExtent});\n  const layergroup = await instantiateMap({mapConfig, credentials: creds});\n\n  const tiles = layergroup.metadata.tilejson.vector;\n  return tiles;\n}\n\n/**\n * Create a mapConfig for Maps API\n */\nfunction createMapConfig({data, bufferSize, version, tileExtent}) {\n  const isSQL = data.search(' ') > -1;\n  const sql = isSQL ? data : `SELECT * FROM ${data}`;\n\n  const mapConfig = {\n    version,\n    buffersize: {\n      mvt: bufferSize\n    },\n    layers: [\n      {\n        type: 'mapnik',\n        options: {\n          sql: sql.trim(),\n          vector_extent: tileExtent\n        }\n      }\n    ]\n  };\n  return mapConfig;\n}\n\n/**\n * Instantiate a map, either by GET or POST, using Maps API\n */\nasync function instantiateMap({mapConfig, credentials}) {\n  let response;\n\n  try {\n    const config = JSON.stringify(mapConfig);\n    const request = createMapsApiRequest({config, credentials});\n    /* global fetch */\n    /* eslint no-undef: \"error\" */\n    response = await fetch(request);\n  } catch (error) {\n    throw new Error(`Failed to connect to Maps API: ${error}`);\n  }\n\n  const layergroup = await response.json();\n\n  if (!response.ok) {\n    dealWithWindshaftError({response, layergroup, credentials});\n  }\n\n  return layergroup;\n}\n\n/**\n * Display proper message from Maps API error\n */\nfunction dealWithWindshaftError({response, layergroup, credentials}) {\n  switch (response.status) {\n    case 401:\n      throw new Error(\n        `Unauthorized access to Maps API: invalid combination of user ('${\n          credentials.username\n        }') and apiKey ('${credentials.apiKey}')`\n      );\n    case 403:\n      throw new Error(\n        `Unauthorized access to dataset: the provided apiKey('${\n          credentials.apiKey\n        }') doesn't provide access to the requested data`\n      );\n    default:\n      throw new Error(`${JSON.stringify(layergroup.errors)}`);\n  }\n}\n\n/**\n * Create a GET or POST request, with all required parameters\n */\nfunction createMapsApiRequest({config, credentials}) {\n  const encodedApiKey = encodeParameter('api_key', credentials.apiKey);\n  const encodedClient = encodeParameter('client', `deck-gl-carto`);\n  const parameters = [encodedApiKey, encodedClient];\n  const url = generateMapsApiUrl(parameters, credentials);\n\n  const getUrl = `${url}&${encodeParameter('config', config)}`;\n  if (getUrl.length < REQUEST_GET_MAX_URL_LENGTH) {\n    return getRequest(getUrl);\n  }\n\n  return postRequest(url, config);\n}\n\n/**\n * Generate a Maps API url for the request\n */\nfunction generateMapsApiUrl(parameters, credentials) {\n  const base = `${serverURL(credentials)}api/v1/map`;\n  return `${base}?${parameters.join('&')}`;\n}\n\n/**\n * Prepare a url valid for the specified user\n */\nfunction serverURL(credentials) {\n  let url = credentials.serverUrlTemplate.replace(\n    DEFAULT_USER_COMPONENT_IN_URL,\n    credentials.username\n  );\n\n  if (!url.endsWith('/')) {\n    url += '/';\n  }\n\n  return url;\n}\n\n/**\n * Simple GET request\n */\nfunction getRequest(url) {\n  /* global Request */\n  /* eslint no-undef: \"error\" */\n  return new Request(url, {\n    method: 'GET',\n    headers: {\n      Accept: 'application/json'\n    }\n  });\n}\n\n/**\n * Simple POST request\n */\nfunction postRequest(url, payload) {\n  return new Request(url, {\n    method: 'POST',\n    headers: {\n      Accept: 'application/json',\n      'Content-Type': 'application/json'\n    },\n    body: payload\n  });\n}\n\n/**\n * Simple encode parameter\n */\nfunction encodeParameter(name, value) {\n  return `${name}=${encodeURIComponent(value)}`;\n}\n"],"file":"maps-api-client.js"}