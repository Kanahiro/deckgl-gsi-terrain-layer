{"version":3,"sources":["../../../src/passes/layers-pass.js"],"names":["Pass","clear","setParameters","withParameters","cssToDeviceRatio","log","LayersPass","render","props","gl","framebuffer","target","_drawLayers","viewports","views","onViewportActive","clearCanvas","clearGLCanvas","renderStats","viewportOrDescriptor","viewport","view","id","drawLayerParams","_getDrawLayerParams","subViewports","subViewport","stats","_drawLayersInViewport","push","layers","pass","layerFilter","effects","moduleParameters","indexResolver","layerIndexResolver","layerIndex","length","layer","shouldDrawLayer","_shouldDrawLayer","layerRenderIndex","layerParam","_getModuleParameters","layerParameters","getLayerParameters","onError","glViewport","getGLViewport","clearOpts","color","depth","scissorTest","scissor","renderStatus","totalCount","visibleCount","compositeCount","pickableCount","pickable","isComposite","drawLayer","uniforms","parameters","err","error","getModuleParameters","visible","isPicking","startsWith","renderPass","activateViewport","overrides","Object","assign","create","autoWrapLongitude","wrapLongitude","context","mousePosition","pickingActive","devicePixelRatio","effect","startIndex","layerIndices","resolvers","resolveLayerIndex","isDrawn","indexOverride","_offset","layerId","parentId","parent","index","resolver","Number","isFinite","height","canvas","clientHeight","dimensions","pixelRatio","x","y","width","drawingBufferWidth","drawingBufferHeight"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport Pass from './pass';\nimport {clear, setParameters, withParameters, cssToDeviceRatio} from '@luma.gl/core';\nimport log from '../utils/log';\n\nexport default class LayersPass extends Pass {\n  render(props) {\n    const gl = this.gl;\n\n    setParameters(gl, {framebuffer: props.target});\n    return this._drawLayers(props);\n  }\n\n  // PRIVATE\n  // Draw a list of layers in a list of viewports\n  _drawLayers(props) {\n    const {viewports, views, onViewportActive, clearCanvas = true} = props;\n\n    const gl = this.gl;\n    if (clearCanvas) {\n      clearGLCanvas(gl);\n    }\n\n    const renderStats = [];\n\n    for (const viewportOrDescriptor of viewports) {\n      // Get a viewport from a viewport descriptor (which can be a plain viewport)\n      const viewport = viewportOrDescriptor.viewport || viewportOrDescriptor;\n      const view = views && views[viewport.id];\n\n      // Update context to point to this viewport\n      onViewportActive(viewport);\n\n      const drawLayerParams = this._getDrawLayerParams(viewport, props);\n\n      props.view = view;\n\n      // render this viewport\n      const subViewports = viewport.subViewports || [viewport];\n      for (const subViewport of subViewports) {\n        props.viewport = subViewport;\n\n        const stats = this._drawLayersInViewport(gl, props, drawLayerParams);\n        renderStats.push(stats);\n      }\n    }\n    return renderStats;\n  }\n\n  // Resolve the parameters needed to draw each layer\n  // When a viewport contains multiple subviewports (e.g. repeated web mercator map),\n  // this is only done once for the parent viewport\n  _getDrawLayerParams(\n    viewport,\n    {layers, pass = 'unknown', layerFilter, effects, moduleParameters}\n  ) {\n    const drawLayerParams = [];\n    const indexResolver = layerIndexResolver();\n    for (let layerIndex = 0; layerIndex < layers.length; layerIndex++) {\n      const layer = layers[layerIndex];\n      // Check if we should draw layer\n      const shouldDrawLayer = this._shouldDrawLayer(layer, viewport, pass, layerFilter);\n\n      // This is the \"logical\" index for ordering this layer in the stack\n      // used to calculate polygon offsets\n      // It can be the same as another layer\n      const layerRenderIndex = indexResolver(layer, shouldDrawLayer);\n\n      const layerParam = {\n        shouldDrawLayer,\n        layerRenderIndex\n      };\n\n      if (shouldDrawLayer) {\n        layerParam.moduleParameters = this._getModuleParameters(\n          layer,\n          effects,\n          pass,\n          moduleParameters\n        );\n        layerParam.layerParameters = this.getLayerParameters(layer, layerIndex);\n      }\n      drawLayerParams[layerIndex] = layerParam;\n    }\n    return drawLayerParams;\n  }\n\n  // Draws a list of layers in one viewport\n  // TODO - when picking we could completely skip rendering viewports that dont\n  // intersect with the picking rect\n  /* eslint-disable max-depth, max-statements */\n  _drawLayersInViewport(gl, {layers, onError, viewport, view}, drawLayerParams) {\n    const glViewport = getGLViewport(gl, {viewport});\n\n    if (view && view.props.clear) {\n      const clearOpts = view.props.clear === true ? {color: true, depth: true} : view.props.clear;\n      withParameters(\n        gl,\n        {\n          scissorTest: true,\n          scissor: glViewport\n        },\n        () => clear(gl, clearOpts)\n      );\n    }\n\n    // render layers in normal colors\n    const renderStatus = {\n      totalCount: layers.length,\n      visibleCount: 0,\n      compositeCount: 0,\n      pickableCount: 0\n    };\n\n    setParameters(gl, {viewport: glViewport});\n\n    // render layers in normal colors\n    for (let layerIndex = 0; layerIndex < layers.length; layerIndex++) {\n      const layer = layers[layerIndex];\n      const {\n        shouldDrawLayer,\n        layerRenderIndex,\n        moduleParameters,\n        layerParameters\n      } = drawLayerParams[layerIndex];\n\n      // Calculate stats\n      if (shouldDrawLayer && layer.props.pickable) {\n        renderStatus.pickableCount++;\n      }\n      if (layer.isComposite) {\n        renderStatus.compositeCount++;\n      } else if (shouldDrawLayer) {\n        // Draw the layer\n        renderStatus.visibleCount++;\n\n        // overwrite layer.context.viewport with the sub viewport\n        moduleParameters.viewport = viewport;\n\n        try {\n          layer.drawLayer({\n            moduleParameters,\n            uniforms: {layerIndex: layerRenderIndex},\n            parameters: layerParameters\n          });\n        } catch (err) {\n          if (onError) {\n            onError(err, layer);\n          } else {\n            log.error(`error during drawing of ${layer}`, err)();\n          }\n        }\n      }\n    }\n\n    return renderStatus;\n  }\n  /* eslint-enable max-depth, max-statements */\n\n  /* Methods for subclass overrides */\n  shouldDrawLayer(layer) {\n    return true;\n  }\n\n  getModuleParameters(layer, effects) {\n    return null;\n  }\n\n  getLayerParameters(layer, layerIndex) {\n    return layer.props.parameters;\n  }\n\n  /* Private */\n  _shouldDrawLayer(layer, viewport, pass, layerFilter) {\n    let shouldDrawLayer = this.shouldDrawLayer(layer) && layer.props.visible;\n\n    if (shouldDrawLayer && layerFilter) {\n      shouldDrawLayer = layerFilter({\n        layer,\n        viewport,\n        isPicking: pass.startsWith('picking'),\n        renderPass: pass\n      });\n    }\n    if (shouldDrawLayer) {\n      // If a layer is drawn, update its viewportChanged flag\n      layer.activateViewport(viewport);\n    }\n\n    return shouldDrawLayer;\n  }\n\n  _getModuleParameters(layer, effects, pass, overrides) {\n    const moduleParameters = Object.assign(Object.create(layer.props), {\n      autoWrapLongitude: layer.wrapLongitude,\n      viewport: layer.context.viewport,\n      mousePosition: layer.context.mousePosition,\n      pickingActive: 0,\n      devicePixelRatio: cssToDeviceRatio(this.gl)\n    });\n\n    if (effects) {\n      for (const effect of effects) {\n        Object.assign(moduleParameters, effect.getModuleParameters(layer));\n      }\n    }\n\n    return Object.assign(moduleParameters, this.getModuleParameters(layer, effects), overrides);\n  }\n}\n\n// If the _index prop is defined, return a layer index that's relative to its parent\n// Otherwise return the index of the layer among all rendered layers\n// This is done recursively, i.e. if the user overrides a layer's default index,\n// all its descendants will be resolved relative to that index.\n// This implementation assumes that parent layers always appear before its children\n// which is true if the layer array comes from the LayerManager\nexport function layerIndexResolver(startIndex = 0, layerIndices = {}) {\n  const resolvers = {};\n\n  const resolveLayerIndex = (layer, isDrawn) => {\n    const indexOverride = layer.props._offset;\n    const layerId = layer.id;\n    const parentId = layer.parent && layer.parent.id;\n\n    let index;\n\n    if (parentId && !(parentId in layerIndices)) {\n      // Populate layerIndices with the parent layer's index\n      resolveLayerIndex(layer.parent, false);\n    }\n\n    if (parentId in resolvers) {\n      const resolver = (resolvers[parentId] =\n        resolvers[parentId] || layerIndexResolver(layerIndices[parentId], layerIndices));\n      index = resolver(layer, isDrawn);\n      resolvers[layerId] = resolver;\n    } else if (Number.isFinite(indexOverride)) {\n      index = indexOverride + (layerIndices[parentId] || 0);\n      // Mark layer as needing its own resolver\n      // We don't actually create it until it's used for the first time\n      resolvers[layerId] = null;\n    } else {\n      index = startIndex;\n    }\n\n    if (isDrawn && index >= startIndex) {\n      startIndex = index + 1;\n    }\n\n    layerIndices[layerId] = index;\n    return index;\n  };\n  return resolveLayerIndex;\n}\n\n// Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\nfunction getGLViewport(gl, {viewport}) {\n  // TODO - dummy default for node\n  // Fallback to width/height when clientWidth/clientHeight are 0 or undefined.\n  const height = gl.canvas ? gl.canvas.clientHeight || gl.canvas.height : 100;\n  // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n  const dimensions = viewport;\n  const pixelRatio = cssToDeviceRatio(gl);\n  return [\n    dimensions.x * pixelRatio,\n    (height - dimensions.y - dimensions.height) * pixelRatio,\n    dimensions.width * pixelRatio,\n    dimensions.height * pixelRatio\n  ];\n}\n\nfunction clearGLCanvas(gl) {\n  const width = gl.drawingBufferWidth;\n  const height = gl.drawingBufferHeight;\n  // clear depth and color buffers, restoring transparency\n  setParameters(gl, {viewport: [0, 0, width, height]});\n  gl.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);\n}\n"],"file":"layers-pass.js"}