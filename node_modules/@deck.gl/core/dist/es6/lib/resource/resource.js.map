{"version":3,"sources":["../../../../src/lib/resource/resource.js"],"names":["load","Resource","constructor","id","data","context","_loadCount","_subscribers","Set","setData","subscribe","consumer","add","unsubscribe","delete","inUse","size","getData","isLoaded","_error","Promise","reject","_content","_loader","then","forceUpdate","_data","loadCount","loader","result","catch","error","subscriber","onChange"],"mappings":"AAAA,SAAQA,IAAR,QAAmB,kBAAnB;AAEA,eAAe,MAAMC,QAAN,CAAe;AAC5BC,EAAAA,WAAW,CAACC,EAAD,EAAKC,IAAL,EAAWC,OAAX,EAAoB;AAC7B,SAAKF,EAAL,GAAUA,EAAV;AACA,SAAKE,OAAL,GAAeA,OAAf;AAEA,SAAKC,UAAL,GAAkB,CAAlB;AACA,SAAKC,YAAL,GAAoB,IAAIC,GAAJ,EAApB;AAEA,SAAKC,OAAL,CAAaL,IAAb;AACD;;AAGDM,EAAAA,SAAS,CAACC,QAAD,EAAW;AAClB,SAAKJ,YAAL,CAAkBK,GAAlB,CAAsBD,QAAtB;AACD;;AAEDE,EAAAA,WAAW,CAACF,QAAD,EAAW;AACpB,SAAKJ,YAAL,CAAkBO,MAAlB,CAAyBH,QAAzB;AACD;;AAEDI,EAAAA,KAAK,GAAG;AACN,WAAO,KAAKR,YAAL,CAAkBS,IAAlB,GAAyB,CAAhC;AACD;;AAEDF,EAAAA,MAAM,GAAG,CAER;;AAEDG,EAAAA,OAAO,GAAG;AACR,WAAO,KAAKC,QAAL,GACH,KAAKC,MAAL,GACEC,OAAO,CAACC,MAAR,CAAe,KAAKF,MAApB,CADF,GAEE,KAAKG,QAHJ,GAIH,KAAKC,OAAL,CAAaC,IAAb,CAAkB,MAAM,KAAKP,OAAL,EAAxB,CAJJ;AAKD;;AAEDR,EAAAA,OAAO,CAACL,IAAD,EAAOqB,WAAP,EAAoB;AACzB,QAAIrB,IAAI,KAAK,KAAKsB,KAAd,IAAuB,CAACD,WAA5B,EAAyC;AACvC;AACD;;AACD,SAAKC,KAAL,GAAatB,IAAb;AACA,UAAMuB,SAAS,GAAG,EAAE,KAAKrB,UAAzB;AAEA,QAAIsB,MAAM,GAAGxB,IAAb;;AACA,QAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC5BwB,MAAAA,MAAM,GAAG5B,IAAI,CAACI,IAAD,CAAb;AACD;;AACD,QAAIwB,MAAM,YAAYR,OAAtB,EAA+B;AAC7B,WAAKF,QAAL,GAAgB,KAAhB;AACA,WAAKK,OAAL,GAAeK,MAAM,CAClBJ,IADY,CACPK,MAAM,IAAI;AAEd,YAAI,KAAKvB,UAAL,KAAoBqB,SAAxB,EAAmC;AACjC,eAAKT,QAAL,GAAgB,IAAhB;AACA,eAAKC,MAAL,GAAc,IAAd;AACA,eAAKG,QAAL,GAAgBO,MAAhB;AACD;AACF,OARY,EASZC,KATY,CASNC,KAAK,IAAI;AACd,YAAI,KAAKzB,UAAL,KAAoBqB,SAAxB,EAAmC;AACjC,eAAKT,QAAL,GAAgB,IAAhB;AACA,eAAKC,MAAL,GAAcY,KAAK,IAAI,IAAvB;AACD;AACF,OAdY,CAAf;AAeD,KAjBD,MAiBO;AACL,WAAKb,QAAL,GAAgB,IAAhB;AACA,WAAKC,MAAL,GAAc,IAAd;AACA,WAAKG,QAAL,GAAgBlB,IAAhB;AACD;;AAED,SAAK,MAAM4B,UAAX,IAAyB,KAAKzB,YAA9B,EAA4C;AAC1CyB,MAAAA,UAAU,CAACC,QAAX,CAAoB,KAAKhB,OAAL,EAApB;AACD;AACF;;AAzE2B","sourcesContent":["import {load} from '@loaders.gl/core';\n\nexport default class Resource {\n  constructor(id, data, context) {\n    this.id = id;\n    this.context = context;\n\n    this._loadCount = 0;\n    this._subscribers = new Set();\n\n    this.setData(data);\n  }\n\n  // consumer: {onChange: Function}\n  subscribe(consumer) {\n    this._subscribers.add(consumer);\n  }\n\n  unsubscribe(consumer) {\n    this._subscribers.delete(consumer);\n  }\n\n  inUse() {\n    return this._subscribers.size > 0;\n  }\n\n  delete() {\n    // Remove any resources created\n  }\n\n  getData() {\n    return this.isLoaded\n      ? this._error\n        ? Promise.reject(this._error)\n        : this._content\n      : this._loader.then(() => this.getData());\n  }\n\n  setData(data, forceUpdate) {\n    if (data === this._data && !forceUpdate) {\n      return;\n    }\n    this._data = data;\n    const loadCount = ++this._loadCount;\n\n    let loader = data;\n    if (typeof data === 'string') {\n      loader = load(data);\n    }\n    if (loader instanceof Promise) {\n      this.isLoaded = false;\n      this._loader = loader\n        .then(result => {\n          // check if source has changed\n          if (this._loadCount === loadCount) {\n            this.isLoaded = true;\n            this._error = null;\n            this._content = result;\n          }\n        })\n        .catch(error => {\n          if (this._loadCount === loadCount) {\n            this.isLoaded = true;\n            this._error = error || true;\n          }\n        });\n    } else {\n      this.isLoaded = true;\n      this._error = null;\n      this._content = data;\n    }\n\n    for (const subscriber of this._subscribers) {\n      subscriber.onChange(this.getData());\n    }\n  }\n}\n"],"file":"resource.js"}