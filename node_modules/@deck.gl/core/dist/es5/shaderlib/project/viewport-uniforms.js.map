{"version":3,"sources":["../../../../src/shaderlib/project/viewport-uniforms.js"],"names":["ZERO_VECTOR","VECTOR_TO_POINT_MATRIX","IDENTITY_MATRIX","DEFAULT_PIXELS_PER_UNIT2","DEFAULT_COORDINATE_ORIGIN","getMemoizedViewportUniforms","calculateViewportUniforms","getOffsetOrigin","viewport","coordinateSystem","coordinateOrigin","shaderCoordinateOrigin","geospatialOrigin","offsetMode","COORDINATE_SYSTEM","LNGLAT_OFFSETS","METER_OFFSETS","isGeospatial","Math","fround","longitude","latitude","projectionMode","PROJECTION_MODE","WEB_MERCATOR","LNGLAT","CARTESIAN","WEB_MERCATOR_AUTO_OFFSET","center","unprojectPosition","IDENTITY","position","map","GLOBE","calculateMatrixAndOffset","viewMatrixUncentered","projectionMatrix","viewMatrix","viewProjectionMatrix","projectionCenter","cameraPosCommon","cameraPosition","positionCommonSpace","projectPosition","vec4","transformMat4","mat4","multiply","getUniformsFromViewport","devicePixelRatio","modelMatrix","DEFAULT","autoWrapLongitude","positionOrigin","uniforms","project_uWrapLongitude","project_uModelMatrix","distanceScales","getDistanceScales","viewportSize","width","height","project_uCoordinateSystem","project_uProjectionMode","project_uCoordinateOrigin","project_uCenter","project_uAntimeridian","project_uViewportSize","project_uDevicePixelRatio","project_uFocalDistance","focalDistance","project_uCommonUnitsPerMeter","unitsPerMeter","project_uCommonUnitsPerWorldUnit","project_uCommonUnitsPerWorldUnit2","project_uScale","scale","project_uViewProjectionMatrix","project_uCameraPosition","distanceScalesAtOrigin","unitsPerMeter2","unitsPerDegree","unitsPerDegree2"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n/* eslint-disable complexity */\n\nimport * as mat4 from 'gl-matrix/mat4';\nimport * as vec4 from 'gl-matrix/vec4';\n\nimport {COORDINATE_SYSTEM, PROJECTION_MODE} from '../../lib/constants';\n\nimport memoize from '../../utils/memoize';\nimport assert from '../../utils/assert';\n\n// To quickly set a vector to zero\nconst ZERO_VECTOR = [0, 0, 0, 0];\n// 4x4 matrix that drops 4th component of vector\nconst VECTOR_TO_POINT_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0];\nconst IDENTITY_MATRIX = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];\nconst DEFAULT_PIXELS_PER_UNIT2 = [0, 0, 0];\nconst DEFAULT_COORDINATE_ORIGIN = [0, 0, 0];\n\nconst getMemoizedViewportUniforms = memoize(calculateViewportUniforms);\n\nexport function getOffsetOrigin(\n  viewport,\n  coordinateSystem,\n  coordinateOrigin = DEFAULT_COORDINATE_ORIGIN\n) {\n  let shaderCoordinateOrigin = coordinateOrigin;\n  let geospatialOrigin;\n  let offsetMode = true;\n\n  if (\n    coordinateSystem === COORDINATE_SYSTEM.LNGLAT_OFFSETS ||\n    coordinateSystem === COORDINATE_SYSTEM.METER_OFFSETS\n  ) {\n    geospatialOrigin = coordinateOrigin;\n  } else {\n    geospatialOrigin = viewport.isGeospatial\n      ? [Math.fround(viewport.longitude), Math.fround(viewport.latitude), 0]\n      : null;\n  }\n\n  switch (viewport.projectionMode) {\n    case PROJECTION_MODE.WEB_MERCATOR:\n      if (\n        coordinateSystem === COORDINATE_SYSTEM.LNGLAT ||\n        coordinateSystem === COORDINATE_SYSTEM.CARTESIAN\n      ) {\n        offsetMode = false;\n      }\n      break;\n\n    case PROJECTION_MODE.WEB_MERCATOR_AUTO_OFFSET:\n      if (coordinateSystem === COORDINATE_SYSTEM.LNGLAT) {\n        // viewport center in world space\n        shaderCoordinateOrigin = geospatialOrigin;\n      } else if (coordinateSystem === COORDINATE_SYSTEM.CARTESIAN) {\n        // viewport center in common space\n        shaderCoordinateOrigin = [\n          Math.fround(viewport.center[0]),\n          Math.fround(viewport.center[1]),\n          0\n        ];\n        // Geospatial origin (wgs84) must match shaderCoordinateOrigin (common)\n        geospatialOrigin = viewport.unprojectPosition(shaderCoordinateOrigin);\n        shaderCoordinateOrigin[0] -= coordinateOrigin[0];\n        shaderCoordinateOrigin[1] -= coordinateOrigin[1];\n        shaderCoordinateOrigin[2] -= coordinateOrigin[2];\n      }\n      break;\n\n    case PROJECTION_MODE.IDENTITY:\n      shaderCoordinateOrigin = viewport.position.map(Math.fround);\n      break;\n\n    case PROJECTION_MODE.GLOBE:\n      offsetMode = false;\n      geospatialOrigin = null;\n      break;\n\n    default:\n      // Unknown projection mode\n      offsetMode = false;\n  }\n\n  shaderCoordinateOrigin[2] = shaderCoordinateOrigin[2] || 0;\n\n  return {geospatialOrigin, shaderCoordinateOrigin, offsetMode};\n}\n\n// The code that utilizes Matrix4 does the same calculation as their mat4 counterparts,\n// has lower performance but provides error checking.\nfunction calculateMatrixAndOffset(viewport, coordinateSystem, coordinateOrigin) {\n  const {viewMatrixUncentered, projectionMatrix} = viewport;\n  let {viewMatrix, viewProjectionMatrix} = viewport;\n\n  let projectionCenter = ZERO_VECTOR;\n  let cameraPosCommon = viewport.cameraPosition;\n  const {geospatialOrigin, shaderCoordinateOrigin, offsetMode} = getOffsetOrigin(\n    viewport,\n    coordinateSystem,\n    coordinateOrigin\n  );\n\n  if (offsetMode) {\n    // Calculate transformed projectionCenter (using 64 bit precision JS)\n    // This is the key to offset mode precision\n    // (avoids doing this addition in 32 bit precision in GLSL)\n    const positionCommonSpace = viewport.projectPosition(\n      geospatialOrigin || shaderCoordinateOrigin\n    );\n\n    cameraPosCommon = [\n      cameraPosCommon[0] - positionCommonSpace[0],\n      cameraPosCommon[1] - positionCommonSpace[1],\n      cameraPosCommon[2] - positionCommonSpace[2]\n    ];\n\n    positionCommonSpace[3] = 1;\n\n    // projectionCenter = new Matrix4(viewProjectionMatrix)\n    //   .transformVector([positionPixels[0], positionPixels[1], 0.0, 1.0]);\n    projectionCenter = vec4.transformMat4([], positionCommonSpace, viewProjectionMatrix);\n\n    // Always apply uncentered projection matrix if available (shader adds center)\n    viewMatrix = viewMatrixUncentered || viewMatrix;\n\n    // Zero out 4th coordinate (\"after\" model matrix) - avoids further translations\n    // viewMatrix = new Matrix4(viewMatrixUncentered || viewMatrix)\n    //   .multiplyRight(VECTOR_TO_POINT_MATRIX);\n    viewProjectionMatrix = mat4.multiply([], projectionMatrix, viewMatrix);\n    viewProjectionMatrix = mat4.multiply([], viewProjectionMatrix, VECTOR_TO_POINT_MATRIX);\n  }\n\n  return {\n    viewMatrix,\n    viewProjectionMatrix,\n    projectionCenter,\n    cameraPosCommon,\n    shaderCoordinateOrigin,\n    geospatialOrigin\n  };\n}\n\n/**\n * Returns uniforms for shaders based on current projection\n * includes: projection matrix suitable for shaders\n *\n * TODO - Ensure this works with any viewport, not just WebMercatorViewports\n *\n * @param {WebMercatorViewport} viewport -\n * @return {Float32Array} - 4x4 projection matrix that can be used in shaders\n */\nexport function getUniformsFromViewport({\n  viewport,\n  devicePixelRatio = 1,\n  modelMatrix = null,\n  // Match Layer.defaultProps\n  coordinateSystem = COORDINATE_SYSTEM.DEFAULT,\n  coordinateOrigin,\n  autoWrapLongitude = false,\n  // Deprecated\n  projectionMode,\n  positionOrigin\n} = {}) {\n  assert(viewport);\n\n  if (coordinateSystem === COORDINATE_SYSTEM.DEFAULT) {\n    coordinateSystem = viewport.isGeospatial\n      ? COORDINATE_SYSTEM.LNGLAT\n      : COORDINATE_SYSTEM.CARTESIAN;\n  }\n\n  const uniforms = getMemoizedViewportUniforms({\n    viewport,\n    devicePixelRatio,\n    coordinateSystem,\n    coordinateOrigin\n  });\n\n  uniforms.project_uWrapLongitude = autoWrapLongitude;\n  uniforms.project_uModelMatrix = modelMatrix || IDENTITY_MATRIX;\n\n  return uniforms;\n}\n\nfunction calculateViewportUniforms({\n  viewport,\n  devicePixelRatio,\n  coordinateSystem,\n  coordinateOrigin\n}) {\n  const {\n    projectionCenter,\n    viewProjectionMatrix,\n    cameraPosCommon,\n    shaderCoordinateOrigin,\n    geospatialOrigin\n  } = calculateMatrixAndOffset(viewport, coordinateSystem, coordinateOrigin);\n\n  // Calculate projection pixels per unit\n  const distanceScales = viewport.getDistanceScales();\n\n  const viewportSize = [viewport.width * devicePixelRatio, viewport.height * devicePixelRatio];\n\n  const uniforms = {\n    // Projection mode values\n    project_uCoordinateSystem: coordinateSystem,\n    project_uProjectionMode: viewport.projectionMode,\n    project_uCoordinateOrigin: shaderCoordinateOrigin,\n    project_uCenter: projectionCenter,\n    project_uAntimeridian: (viewport.longitude || 0) - 180,\n\n    // Screen size\n    project_uViewportSize: viewportSize,\n    project_uDevicePixelRatio: devicePixelRatio,\n\n    // Distance at which screen pixels are projected\n    project_uFocalDistance: viewport.focalDistance || 1,\n    project_uCommonUnitsPerMeter: distanceScales.unitsPerMeter,\n    project_uCommonUnitsPerWorldUnit: distanceScales.unitsPerMeter,\n    project_uCommonUnitsPerWorldUnit2: DEFAULT_PIXELS_PER_UNIT2,\n    project_uScale: viewport.scale, // This is the mercator scale (2 ** zoom)\n\n    project_uViewProjectionMatrix: viewProjectionMatrix,\n\n    // This is for lighting calculations\n    project_uCameraPosition: cameraPosCommon\n  };\n\n  if (geospatialOrigin) {\n    const distanceScalesAtOrigin = viewport.getDistanceScales(geospatialOrigin);\n    switch (coordinateSystem) {\n      case COORDINATE_SYSTEM.METER_OFFSETS:\n        uniforms.project_uCommonUnitsPerWorldUnit = distanceScalesAtOrigin.unitsPerMeter;\n        uniforms.project_uCommonUnitsPerWorldUnit2 = distanceScalesAtOrigin.unitsPerMeter2;\n        break;\n\n      case COORDINATE_SYSTEM.LNGLAT:\n      case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n        uniforms.project_uCommonUnitsPerWorldUnit = distanceScalesAtOrigin.unitsPerDegree;\n        uniforms.project_uCommonUnitsPerWorldUnit2 = distanceScalesAtOrigin.unitsPerDegree2;\n        break;\n\n      // a.k.a \"preprojected\" positions\n      case COORDINATE_SYSTEM.CARTESIAN:\n        uniforms.project_uCommonUnitsPerWorldUnit = [1, 1, distanceScalesAtOrigin.unitsPerMeter[2]];\n        uniforms.project_uCommonUnitsPerWorldUnit2 = [\n          0,\n          0,\n          distanceScalesAtOrigin.unitsPerMeter2[2]\n        ];\n        break;\n\n      default:\n        break;\n    }\n  }\n\n  return uniforms;\n}\n"],"file":"viewport-uniforms.js"}