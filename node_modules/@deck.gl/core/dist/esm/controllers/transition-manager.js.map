{"version":3,"sources":["../../../src/controllers/transition-manager.js"],"names":["LinearInterpolator","Transition","noop","TRANSITION_EVENTS","BREAK","SNAP_TO_END","IGNORE","DEFAULT_PROPS","transitionDuration","transitionEasing","t","transitionInterpolator","transitionInterruption","onTransitionStart","onTransitionInterrupt","onTransitionEnd","TransitionManager","ControllerState","props","Object","assign","propsInTransition","transition","timeline","onViewStateChange","_onTransitionUpdate","bind","cancel","nextProps","transitionTriggered","currentProps","_shouldIgnoreViewportChange","_isTransitionEnabled","settings","interruption","endProps","startProps","_triggerTransition","update","Boolean","inProgress","interpolator","arePropsEqual","_isUpdateDueToCurrentTransition","startViewstate","endViewStateProps","shortestPathFrom","duration","getDuration","initialProps","initializeProps","start","easing","end","onStart","onUpdate","onInterrupt","_onTransitionEnd","onEnd","updateTransition","callback","time","viewport","interpolateProps","getViewportProps","viewState","interactionState","inTransition","oldViewState","defaultProps"],"mappings":";;AAAA,OAAOA,kBAAP,MAA+B,oCAA/B;AACA,OAAOC,UAAP,MAAuB,2BAAvB;;AAEA,IAAMC,IAAI,GAAG,SAAPA,IAAO,GAAM,CAAE,CAArB;;AAEA,OAAO,IAAMC,iBAAiB,GAAG;AAC/BC,EAAAA,KAAK,EAAE,CADwB;AAE/BC,EAAAA,WAAW,EAAE,CAFkB;AAG/BC,EAAAA,MAAM,EAAE;AAHuB,CAA1B;AAMP,IAAMC,aAAa,GAAG;AACpBC,EAAAA,kBAAkB,EAAE,CADA;AAEpBC,EAAAA,gBAAgB,EAAE,0BAAAC,CAAC;AAAA,WAAIA,CAAJ;AAAA,GAFC;AAGpBC,EAAAA,sBAAsB,EAAE,IAAIX,kBAAJ,EAHJ;AAIpBY,EAAAA,sBAAsB,EAAET,iBAAiB,CAACC,KAJtB;AAKpBS,EAAAA,iBAAiB,EAAEX,IALC;AAMpBY,EAAAA,qBAAqB,EAAEZ,IANH;AAOpBa,EAAAA,eAAe,EAAEb;AAPG,CAAtB;;IAUqBc,iB;AACnB,6BAAYC,eAAZ,EAAyC;AAAA,QAAZC,KAAY,uEAAJ,EAAI;;AAAA;;AACvC,SAAKD,eAAL,GAAuBA,eAAvB;AACA,SAAKC,KAAL,GAAaC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBb,aAAlB,EAAiCW,KAAjC,CAAb;AACA,SAAKG,iBAAL,GAAyB,IAAzB;AACA,SAAKC,UAAL,GAAkB,IAAIrB,UAAJ,CAAeiB,KAAK,CAACK,QAArB,CAAlB;AAEA,SAAKC,iBAAL,GAAyBN,KAAK,CAACM,iBAA/B;AAEA,SAAKC,mBAAL,GAA2B,KAAKA,mBAAL,CAAyBC,IAAzB,CAA8B,IAA9B,CAA3B;AACD;;;;+BAEU;AACT,WAAKJ,UAAL,CAAgBK,MAAhB;AACD;;;8CAGyB;AACxB,aAAO,KAAKN,iBAAZ;AACD;;;2CAIsBO,S,EAAW;AAChC,UAAIC,mBAAmB,GAAG,KAA1B;AACA,UAAMC,YAAY,GAAG,KAAKZ,KAA1B;AAEAU,MAAAA,SAAS,GAAGT,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBb,aAAlB,EAAiCqB,SAAjC,CAAZ;AACA,WAAKV,KAAL,GAAaU,SAAb;;AAGA,UAAI,KAAKG,2BAAL,CAAiCD,YAAjC,EAA+CF,SAA/C,CAAJ,EAA+D;AAC7D,eAAOC,mBAAP;AACD;;AAED,UAAI,KAAKG,oBAAL,CAA0BJ,SAA1B,CAAJ,EAA0C;AAAA,oCACP,KAAKN,UAAL,CAAgBW,QADT;AAAA,YACjCC,YADiC,yBACjCA,YADiC;AAAA,YACnBC,QADmB,yBACnBA,QADmB;AAExC,YAAMC,UAAU,GAAGjB,MAAM,CAACC,MAAP,CACjB,EADiB,EAEjBU,YAFiB,EAGjBI,YAAY,KAAK/B,iBAAiB,CAACE,WAAnC,GACI8B,QADJ,GAEI,KAAKd,iBAAL,IAA0BS,YALb,CAAnB;;AAQA,aAAKO,kBAAL,CAAwBD,UAAxB,EAAoCR,SAApC;;AAEAC,QAAAA,mBAAmB,GAAG,IAAtB;AACD,OAbD,MAaO;AACL,aAAKP,UAAL,CAAgBK,MAAhB;AACD;;AAED,aAAOE,mBAAP;AACD;;;uCAEkB;AACjB,WAAKP,UAAL,CAAgBgB,MAAhB;AACD;;;yCAIoBpB,K,EAAO;AAAA,UACnBV,kBADmB,GAC2BU,KAD3B,CACnBV,kBADmB;AAAA,UACCG,sBADD,GAC2BO,KAD3B,CACCP,sBADD;AAE1B,aACE,CAACH,kBAAkB,GAAG,CAArB,IAA0BA,kBAAkB,KAAK,MAAlD,KAA6D+B,OAAO,CAAC5B,sBAAD,CADtE;AAGD;;;oDAE+BO,K,EAAO;AACrC,UAAI,KAAKI,UAAL,CAAgBkB,UAApB,EAAgC;AAC9B,eAAO,KAAKlB,UAAL,CAAgBW,QAAhB,CAAyBQ,YAAzB,CAAsCC,aAAtC,CAAoDxB,KAApD,EAA2D,KAAKG,iBAAhE,CAAP;AACD;;AACD,aAAO,KAAP;AACD;;;gDAE2BS,Y,EAAcF,S,EAAW;AACnD,UAAI,KAAKN,UAAL,CAAgBkB,UAApB,EAAgC;AAE9B,eACE,KAAKlB,UAAL,CAAgBW,QAAhB,CAAyBC,YAAzB,KAA0C/B,iBAAiB,CAACG,MAA5D,IAEA,KAAKqC,+BAAL,CAAqCf,SAArC,CAHF;AAKD,OAPD,MAOO,IAAI,KAAKI,oBAAL,CAA0BJ,SAA1B,CAAJ,EAA0C;AAE/C,eAAOA,SAAS,CAACjB,sBAAV,CAAiC+B,aAAjC,CAA+CZ,YAA/C,EAA6DF,SAA7D,CAAP;AACD;;AACD,aAAO,IAAP;AACD;;;uCAEkBQ,U,EAAYD,Q,EAAU;AACvC,UAAMS,cAAc,GAAG,IAAI,KAAK3B,eAAT,CAAyBmB,UAAzB,CAAvB;AACA,UAAMS,iBAAiB,GAAG,IAAI,KAAK5B,eAAT,CAAyBkB,QAAzB,EAAmCW,gBAAnC,CAAoDF,cAApD,CAA1B;AAFuC,UAKhCjC,sBALgC,GAKNwB,QALM,CAKhCxB,sBALgC;AAMvC,UAAMoC,QAAQ,GAAGpC,sBAAsB,CAACqC,WAAvB,GACbrC,sBAAsB,CAACqC,WAAvB,CAAmCZ,UAAnC,EAA+CD,QAA/C,CADa,GAEbA,QAAQ,CAAC3B,kBAFb;;AAIA,UAAIuC,QAAQ,KAAK,CAAjB,EAAoB;AAClB;AACD;;AAED,UAAME,YAAY,GAAGd,QAAQ,CAACxB,sBAAT,CAAgCuC,eAAhC,CACnBd,UADmB,EAEnBS,iBAFmB,CAArB;AAKA,WAAKxB,iBAAL,GAAyB,EAAzB;AACA,WAAK0B,QAAL,GAAgBA,QAAhB;AACA,WAAKzB,UAAL,CAAgB6B,KAAhB,CAAsB;AACpBJ,QAAAA,QAAQ,EAARA,QADoB;AAEpBK,QAAAA,MAAM,EAAEjB,QAAQ,CAAC1B,gBAFG;AAGpBgC,QAAAA,YAAY,EAAEN,QAAQ,CAACxB,sBAHH;AAIpBuB,QAAAA,YAAY,EAAEC,QAAQ,CAACvB,sBAJH;AAMpBwB,QAAAA,UAAU,EAAEa,YAAY,CAACE,KANL;AAOpBhB,QAAAA,QAAQ,EAAEc,YAAY,CAACI,GAPH;AASpBC,QAAAA,OAAO,EAAEnB,QAAQ,CAACtB,iBATE;AAUpB0C,QAAAA,QAAQ,EAAE,KAAK9B,mBAVK;AAWpB+B,QAAAA,WAAW,EAAE,KAAKC,gBAAL,CAAsBtB,QAAQ,CAACrB,qBAA/B,CAXO;AAYpB4C,QAAAA,KAAK,EAAE,KAAKD,gBAAL,CAAsBtB,QAAQ,CAACpB,eAA/B;AAZa,OAAtB;AAcA,WAAK4C,gBAAL;AACD;;;qCAEgBC,Q,EAAU;AAAA;;AACzB,aAAO,UAAAtC,UAAU,EAAI;AACnB,QAAA,KAAI,CAACD,iBAAL,GAAyB,IAAzB;AACAuC,QAAAA,QAAQ,CAACtC,UAAD,CAAR;AACD,OAHD;AAID;;;wCAEmBA,U,EAAY;AAAA,UAG5BuC,IAH4B,GAK1BvC,UAL0B,CAG5BuC,IAH4B;AAAA,iCAK1BvC,UAL0B,CAI5BW,QAJ4B;AAAA,UAIjBQ,YAJiB,wBAIjBA,YAJiB;AAAA,UAIHL,UAJG,wBAIHA,UAJG;AAAA,UAISD,QAJT,wBAISA,QAJT;AAAA,UAImBY,QAJnB,wBAImBA,QAJnB;AAAA,UAI6BK,MAJ7B,wBAI6BA,MAJ7B;AAM9B,UAAM1C,CAAC,GAAG0C,MAAM,CAACS,IAAI,GAAGd,QAAR,CAAhB;AACA,UAAMe,QAAQ,GAAGrB,YAAY,CAACsB,gBAAb,CAA8B3B,UAA9B,EAA0CD,QAA1C,EAAoDzB,CAApD,CAAjB;AAIA,WAAKW,iBAAL,GAAyB,IAAI,KAAKJ,eAAT,CACvBE,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKF,KAAvB,EAA8B4C,QAA9B,CADuB,EAEvBE,gBAFuB,EAAzB;;AAIA,UAAI,KAAKxC,iBAAT,EAA4B;AAC1B,aAAKA,iBAAL,CAAuB;AACrByC,UAAAA,SAAS,EAAE,KAAK5C,iBADK;AAErB6C,UAAAA,gBAAgB,EAAE;AAACC,YAAAA,YAAY,EAAE;AAAf,WAFG;AAGrBC,UAAAA,YAAY,EAAE,KAAKlD;AAHE,SAAvB;AAKD;AACF;;;;;;SA7JkBF,iB;AAgKrBA,iBAAiB,CAACqD,YAAlB,GAAiC9D,aAAjC","sourcesContent":["import LinearInterpolator from '../transitions/linear-interpolator';\nimport Transition from '../transitions/transition';\n\nconst noop = () => {};\n\nexport const TRANSITION_EVENTS = {\n  BREAK: 1,\n  SNAP_TO_END: 2,\n  IGNORE: 3\n};\n\nconst DEFAULT_PROPS = {\n  transitionDuration: 0,\n  transitionEasing: t => t,\n  transitionInterpolator: new LinearInterpolator(),\n  transitionInterruption: TRANSITION_EVENTS.BREAK,\n  onTransitionStart: noop,\n  onTransitionInterrupt: noop,\n  onTransitionEnd: noop\n};\n\nexport default class TransitionManager {\n  constructor(ControllerState, props = {}) {\n    this.ControllerState = ControllerState;\n    this.props = Object.assign({}, DEFAULT_PROPS, props);\n    this.propsInTransition = null;\n    this.transition = new Transition(props.timeline);\n\n    this.onViewStateChange = props.onViewStateChange;\n\n    this._onTransitionUpdate = this._onTransitionUpdate.bind(this);\n  }\n\n  finalize() {\n    this.transition.cancel();\n  }\n\n  // Returns current transitioned viewport.\n  getViewportInTransition() {\n    return this.propsInTransition;\n  }\n\n  // Process the vewiport change, either ignore or trigger a new transition.\n  // Return true if a new transition is triggered, false otherwise.\n  processViewStateChange(nextProps) {\n    let transitionTriggered = false;\n    const currentProps = this.props;\n    // Set this.props here as '_triggerTransition' calls '_updateViewport' that uses this.props.\n    nextProps = Object.assign({}, DEFAULT_PROPS, nextProps);\n    this.props = nextProps;\n\n    // NOTE: Be cautious re-ordering statements in this function.\n    if (this._shouldIgnoreViewportChange(currentProps, nextProps)) {\n      return transitionTriggered;\n    }\n\n    if (this._isTransitionEnabled(nextProps)) {\n      const {interruption, endProps} = this.transition.settings;\n      const startProps = Object.assign(\n        {},\n        currentProps,\n        interruption === TRANSITION_EVENTS.SNAP_TO_END\n          ? endProps\n          : this.propsInTransition || currentProps\n      );\n\n      this._triggerTransition(startProps, nextProps);\n\n      transitionTriggered = true;\n    } else {\n      this.transition.cancel();\n    }\n\n    return transitionTriggered;\n  }\n\n  updateTransition() {\n    this.transition.update();\n  }\n\n  // Helper methods\n\n  _isTransitionEnabled(props) {\n    const {transitionDuration, transitionInterpolator} = props;\n    return (\n      (transitionDuration > 0 || transitionDuration === 'auto') && Boolean(transitionInterpolator)\n    );\n  }\n\n  _isUpdateDueToCurrentTransition(props) {\n    if (this.transition.inProgress) {\n      return this.transition.settings.interpolator.arePropsEqual(props, this.propsInTransition);\n    }\n    return false;\n  }\n\n  _shouldIgnoreViewportChange(currentProps, nextProps) {\n    if (this.transition.inProgress) {\n      // Ignore update if it is requested to be ignored\n      return (\n        this.transition.settings.interruption === TRANSITION_EVENTS.IGNORE ||\n        // Ignore update if it is due to current active transition.\n        this._isUpdateDueToCurrentTransition(nextProps)\n      );\n    } else if (this._isTransitionEnabled(nextProps)) {\n      // Ignore if none of the viewport props changed.\n      return nextProps.transitionInterpolator.arePropsEqual(currentProps, nextProps);\n    }\n    return true;\n  }\n\n  _triggerTransition(startProps, endProps) {\n    const startViewstate = new this.ControllerState(startProps);\n    const endViewStateProps = new this.ControllerState(endProps).shortestPathFrom(startViewstate);\n\n    // update transitionDuration for 'auto' mode\n    const {transitionInterpolator} = endProps;\n    const duration = transitionInterpolator.getDuration\n      ? transitionInterpolator.getDuration(startProps, endProps)\n      : endProps.transitionDuration;\n\n    if (duration === 0) {\n      return;\n    }\n\n    const initialProps = endProps.transitionInterpolator.initializeProps(\n      startProps,\n      endViewStateProps\n    );\n\n    this.propsInTransition = {};\n    this.duration = duration;\n    this.transition.start({\n      duration,\n      easing: endProps.transitionEasing,\n      interpolator: endProps.transitionInterpolator,\n      interruption: endProps.transitionInterruption,\n\n      startProps: initialProps.start,\n      endProps: initialProps.end,\n\n      onStart: endProps.onTransitionStart,\n      onUpdate: this._onTransitionUpdate,\n      onInterrupt: this._onTransitionEnd(endProps.onTransitionInterrupt),\n      onEnd: this._onTransitionEnd(endProps.onTransitionEnd)\n    });\n    this.updateTransition();\n  }\n\n  _onTransitionEnd(callback) {\n    return transition => {\n      this.propsInTransition = null;\n      callback(transition);\n    };\n  }\n\n  _onTransitionUpdate(transition) {\n    // NOTE: Be cautious re-ordering statements in this function.\n    const {\n      time,\n      settings: {interpolator, startProps, endProps, duration, easing}\n    } = transition;\n    const t = easing(time / duration);\n    const viewport = interpolator.interpolateProps(startProps, endProps, t);\n\n    // This gurantees all props (e.g. bearing, longitude) are normalized\n    // So when viewports are compared they are in same range.\n    this.propsInTransition = new this.ControllerState(\n      Object.assign({}, this.props, viewport)\n    ).getViewportProps();\n\n    if (this.onViewStateChange) {\n      this.onViewStateChange({\n        viewState: this.propsInTransition,\n        interactionState: {inTransition: true},\n        oldViewState: this.props\n      });\n    }\n  }\n}\n\nTransitionManager.defaultProps = DEFAULT_PROPS;\n"],"file":"transition-manager.js"}