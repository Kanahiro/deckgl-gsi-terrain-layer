{"version":3,"sources":["../../../src/controllers/first-person-controller.js"],"names":["Controller","ViewState","mod","Vector3","_SphericalCoordinates","SphericalCoordinates","clamp","MOVEMENT_SPEED","DEFAULT_STATE","position","pitch","bearing","maxPitch","minPitch","FirstPersonState","width","height","longitude","latitude","startBearing","startPitch","startZoomPosition","startZoom","_interactiveState","use2D","spherical","_viewportProps","direction","toVector3","normalize","pos","_getUpdatedState","deltaScaleX","deltaScaleY","Number","isFinite","zoom","scale","getDirection","_move","Math","log2","rotateZ","radians","PI","negate","viewState","fromProps","getViewportProps","props","Object","assign","abs","speed","fromPosition","delta","add","newProps","FirstPersonController"],"mappings":"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","sourcesContent":["import Controller from './controller';\nimport ViewState from './view-state';\nimport {mod} from '../utils/math-utils';\n\nimport {Vector3, _SphericalCoordinates as SphericalCoordinates, clamp} from 'math.gl';\n\nconst MOVEMENT_SPEED = 20;\nconst DEFAULT_STATE = {\n  position: [0, 0, 0],\n  pitch: 0,\n  bearing: 0,\n  maxPitch: 90,\n  minPitch: -90\n};\n\nclass FirstPersonState extends ViewState {\n  constructor({\n    /* Viewport arguments */\n    width, // Width of viewport\n    height, // Height of viewport\n\n    // Position and orientation\n    position = DEFAULT_STATE.position, // typically in meters from anchor point\n\n    bearing = DEFAULT_STATE.bearing, // Rotation around y axis\n    pitch = DEFAULT_STATE.pitch, // Rotation around x axis\n\n    // Geospatial anchor\n    longitude,\n    latitude,\n\n    maxPitch = DEFAULT_STATE.maxPitch,\n    minPitch = DEFAULT_STATE.minPitch,\n\n    // Model state when the rotate operation first started\n    startBearing,\n    startPitch,\n    startZoomPosition,\n    startZoom\n  }) {\n    super({\n      width,\n      height,\n      position,\n      bearing,\n      pitch,\n      longitude,\n      latitude,\n      maxPitch,\n      minPitch\n    });\n\n    this._interactiveState = {\n      startBearing,\n      startPitch,\n      startZoomPosition,\n      startZoom\n    };\n  }\n\n  /* Public API */\n\n  getInteractiveState() {\n    return this._interactiveState;\n  }\n\n  getDirection(use2D = false) {\n    const spherical = new SphericalCoordinates({\n      bearing: this._viewportProps.bearing,\n      pitch: use2D ? 90 : 90 + this._viewportProps.pitch\n    });\n    const direction = spherical.toVector3().normalize();\n    return direction;\n  }\n\n  /**\n   * Start panning\n   * @param {[Number, Number]} pos - position on screen where the pointer grabs\n   */\n  panStart() {\n    return this;\n  }\n\n  /**\n   * Pan\n   * @param {[Number, Number]} pos - position on screen where the pointer is\n   */\n  pan() {\n    return this;\n  }\n\n  /**\n   * End panning\n   * Must call if `panStart()` was called\n   */\n  panEnd() {\n    return this;\n  }\n\n  /**\n   * Start rotating\n   * @param {[Number, Number]} pos - position on screen where the pointer grabs\n   */\n  rotateStart({pos}) {\n    return this._getUpdatedState({\n      startBearing: this._viewportProps.bearing,\n      startPitch: this._viewportProps.pitch\n    });\n  }\n\n  /**\n   * Rotate\n   * @param {[Number, Number]} pos - position on screen where the pointer is\n   */\n  rotate({deltaScaleX, deltaScaleY}) {\n    const {startBearing, startPitch} = this._interactiveState;\n\n    if (!Number.isFinite(startBearing) || !Number.isFinite(startPitch)) {\n      return this;\n    }\n\n    return this._getUpdatedState({\n      bearing: startBearing - deltaScaleX * 180,\n      pitch: startPitch - deltaScaleY * 90\n    });\n  }\n\n  /**\n   * End rotating\n   * Must call if `rotateStart()` was called\n   */\n  rotateEnd() {\n    return this._getUpdatedState({\n      startBearing: null,\n      startPitch: null\n    });\n  }\n\n  /**\n   * Start zooming\n   * @param {[Number, Number]} pos - position on screen where the pointer grabs\n   */\n  zoomStart() {\n    return this._getUpdatedState({\n      startZoomPosition: this._viewportProps.position,\n      startZoom: this._viewportProps.zoom\n    });\n  }\n\n  /**\n   * Zoom\n   * @param {[Number, Number]} pos - position on screen where the current center is\n   * @param {[Number, Number]} startPos - the center position at\n   *   the start of the operation. Must be supplied of `zoomStart()` was not called\n   * @param {Number} scale - a number between [0, 1] specifying the accumulated\n   *   relative scale.\n   */\n  zoom({scale}) {\n    let {startZoomPosition} = this._interactiveState;\n    if (!startZoomPosition) {\n      startZoomPosition = this._viewportProps.position;\n    }\n\n    const direction = this.getDirection();\n    return this._move(direction, Math.log2(scale), startZoomPosition);\n  }\n\n  /**\n   * End zooming\n   * Must call if `zoomStart()` was called\n   */\n  zoomEnd() {\n    return this._getUpdatedState({\n      startZoomPosition: null,\n      startZoom: null\n    });\n  }\n\n  moveLeft() {\n    const direction = this.getDirection(true);\n    return this._move(direction.rotateZ({radians: Math.PI / 2}));\n  }\n\n  moveRight() {\n    const direction = this.getDirection(true);\n    return this._move(direction.rotateZ({radians: -Math.PI / 2}));\n  }\n\n  // forward\n  moveUp() {\n    const direction = this.getDirection(true);\n    return this._move(direction);\n  }\n\n  // backward\n  moveDown() {\n    const direction = this.getDirection(true);\n    return this._move(direction.negate());\n  }\n\n  rotateLeft() {\n    return this._getUpdatedState({\n      bearing: this._viewportProps.bearing - 15\n    });\n  }\n\n  rotateRight() {\n    return this._getUpdatedState({\n      bearing: this._viewportProps.bearing + 15\n    });\n  }\n\n  rotateUp() {\n    return this._getUpdatedState({\n      pitch: this._viewportProps.pitch + 10\n    });\n  }\n\n  rotateDown() {\n    return this._getUpdatedState({\n      pitch: this._viewportProps.pitch - 10\n    });\n  }\n\n  zoomIn() {\n    return this.zoom({scale: 2});\n  }\n\n  zoomOut() {\n    return this.zoom({scale: 0.5});\n  }\n\n  // shortest path between two view states\n  shortestPathFrom(viewState) {\n    const fromProps = viewState.getViewportProps();\n    const props = Object.assign({}, this._viewportProps);\n    const {bearing, longitude} = props;\n\n    if (Math.abs(bearing - fromProps.bearing) > 180) {\n      props.bearing = bearing < 0 ? bearing + 360 : bearing - 360;\n    }\n    if (Math.abs(longitude - fromProps.longitude) > 180) {\n      props.longitude = longitude < 0 ? longitude + 360 : longitude - 360;\n    }\n    return props;\n  }\n\n  /* Private methods */\n  _move(direction, speed = 1, fromPosition = this._viewportProps.position) {\n    const delta = direction.scale(speed * MOVEMENT_SPEED);\n    return this._getUpdatedState({\n      position: new Vector3(fromPosition).add(delta)\n    });\n  }\n\n  _getUpdatedState(newProps) {\n    // Update _viewportProps\n    return new FirstPersonState(\n      Object.assign({}, this._viewportProps, this._interactiveState, newProps)\n    );\n  }\n\n  // Apply any constraints (mathematical or defined by _viewportProps) to map state\n  _applyConstraints(props) {\n    // Ensure pitch and zoom are within specified range\n    const {pitch, maxPitch, minPitch, longitude, bearing} = props;\n    props.pitch = clamp(pitch, minPitch, maxPitch);\n\n    // Normalize degrees\n    if (longitude < -180 || longitude > 180) {\n      props.longitude = mod(longitude + 180, 360) - 180;\n    }\n    if (bearing < -180 || bearing > 180) {\n      props.bearing = mod(bearing + 180, 360) - 180;\n    }\n\n    return props;\n  }\n}\n\nexport default class FirstPersonController extends Controller {\n  constructor(props) {\n    super(FirstPersonState, props);\n  }\n}\n"],"file":"first-person-controller.js"}